<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8" />

  
  <title>Go Rpc</title>

  
  
  <link href="//cdn.jsdelivr.net" rel="dns-prefetch">
  <link href="//cdnjs.cloudflare.com" rel="dns-prefetch">
  
  <link href="//at.alicdn.com" rel="dns-prefetch">
  
  <link href="//fonts.googleapis.com" rel="dns-prefetch">
  <link href="//fonts.gstatic.com" rel="dns-prefetch">
  <link href="///disqus.com" rel="dns-prefetch">
  <link href="//c.disquscdn.com" rel="dns-prefetch">
  
  <link href="//www.google-analytics.com" rel="dns-prefetch">
  

  

  
  
  <meta name="description" content="Rpc (Remote Procedure Call) 远程过程调用RPC, 就是客户端基于某种传输协议通过网络向服务提供端请求服务处理, 然后获取反回数据; 这种调用对于客户端而言和本地调用一样方便, 开发人员不需要了解具体的底层网络传输协议. 简单讲, 就是本地调用的逻辑处理的过程放在远程的机器上.
RPC架构 一般，远程过程调用RPC就是本地动态代理隐藏通信细节，通过组件序列化请求，走网络到服务端，执行真正的服务代码，然后将结果返回给客户端，反序列化数据给调用方法的过程。
RPC具体调用流程如下所示：
![RPC调用流程](/Users/lx/OneDrive - RLS ,inc/markdown/grpc-go-stack.png)
通用的RPC组件一般包括以下一些模块：
serviceClient：这个模块主要是封装服务端对外提供的API，让客户端像使用本地API接口一样调用远程服务。一般，我们使用动态代理机制，当客户端调用api的方法时，serviceClient会走代理逻辑，去远程服务器请求真正的执行方法，然后将响应结果作为本地的api方法执行结果返回给客户端应用。类似RMI的stub模块。 processor：在服务端存在很多方法，当客户端请求过来，服务端需要定位到具体对象的具体方法，然后执行该方法，这个功能就由processor模块来完成。一般这个操作需要使用反射机制来获取用来执行真实处理逻辑的方法，当然，有的RPC直接在server初始化的时候，将一定规则写进Map映射中，这样直接获取对象即可。类似RMI的skeleton模块。 protocol：协议层，这是每个RPC组件的核心技术所在。一般，协议层包括编码/解码，或者说序列化和反序列化工作；当然，有的时候编解码不仅仅是对象序列化的工作，还有一些通信相关的字节流的额外解析部分。序列化工具有：hessian，protobuf，avro,thrift，json系，xml系等等。在RMI中这块是直接使用JDK自身的序列化组件。 transport：传输层，主要是服务端和客户端网络通信相关的功能。这里和下面的IO层区分开，主要是因为传输层处理server/client的网络通信交互，而不涉及具体底层处理连接请求和响应相关的逻辑。 I/O：这个模块主要是为了提高性能可能采用不同的IO模型和线程模型，当然，一般我们可能和上面的transport层联系的比较紧密，统一称为remote模块。 此外，还有业务代码自己去实现的client和server层。client当需要远程调用服务时，会首先初始化一个API接口代理对象，然后调用某个代理方法。server在对外暴露服务时，需要首先实现对应API接口内部的方法，当请求过来时，通过反射找到对应的实例对象，执行对应的业务代码。
![img](/Users/lx/OneDrive - RLS ,inc/markdown/rpc框架.png)
JSON-RPC 1.JSON-RPC介绍 JSON-RPC是一个无状态且轻量级的RPC协议，其传输内容以JSON方式，相对于一般的HTTP请求通过URI调用远程服务器，JSON-RPC直接在内容中定义了要调用的函数名称（如 {“method”: “getUser”}），对于开发者来说非常的方便。Bitcoin和Ethereum都支持JSON-RPC通过客户端直接调用节点上的函数或方法。 注意: 以rpc开头的方法名预留作为系统扩展，且必须不能用于其他地方。
2.约定 由于JSON-RPC使用JSON，它具有与其相同的类型系统(见http://www.json.org或RFC 4627)。JSON可以表示四个基本类型(String、Numbers、Booleans和Null)和两个结构化类型(Objects和Arrays)。 规范中，术语“Primitive”标记那4种原始类型，“Structured”标记两种结构化类型。任何时候文档涉及JSON数据类型，第一个字母都必须大写：Object，Array，String，Number，Boolean，Null。包括True和False也要大写。
在客户端与任何被匹配到的服务端之间交换的所有成员名字应是区分大小写的。 函数、方法、过程都可以认为是可以互换的。
客户端被定义为请求对象的来源及响应对象的处理程序。
服务端被定义为响应对象的起源和请求对象的处理程序。
该规范的一种实现为可以轻而易举的填补这两个角色,即使是在同一时间,同一客户端或其他不相同的客户端。 该规范不涉及复杂层。
3.JSON-RPC请求 JSON-RPC 2.0和1.0之间一些差异，我们这里介绍2.0的使用，一个JSON-RPC的请求必须包含以下4个字段。
1.jsonrpc: 指定JSON-RPC的版本，必须设置为2.0 2.id: 已建立客户端的唯一标识id，值必须包含一个字符串、数值或NULL空值。如果不包含该成员则被认定为是一个通知。该值一般不为NULL，若为数值则不应该包含小数。 3.method: 包含所要调用方法名称的字符串，以rpc开头的方法名，用英文句号连接的为预留给rpc内部的方法名及扩展名，且不能在其他地方使用。 4.params: 方法传入的参数，若无参数则传入空[] 4.JSON-RPC响应 当发起一个RPC调用时，除通知之外服务端都必须有响应，响应表示为一个JSON对象包含以下几个字段。
1.jsonrpc: 指定JSON-RPC的版本，固定为为2.0 2.id: 调用标识符，用于标示一次远程调用过程，值必须包含一个字符串、数值。 3.result: 如果调用成功则显示响应结果 4.error: 如果调用失败则显示错误的信息，error带有以下几个字段 4.1.code: 使用数值表示该异常的错误类型，必须为整数 【必须】 4.">

  
  
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@twitter_username">
    <meta name="twitter:title" content="Go Rpc">
    <meta name="twitter:description" content="Rpc (Remote Procedure Call) 远程过程调用RPC, 就是客户端基于某种传输协议通过网络向服务提供端请求服务处理, 然后获取反回数据; 这种调用对于客户端而言和本地调用一样方便, 开发人员不需要了解具体的底层网络传输协议. 简单讲, 就是本地调用的逻辑处理的过程放在远程的机器上.
RPC架构 一般，远程过程调用RPC就是本地动态代理隐藏通信细节，通过组件序列化请求，走网络到服务端，执行真正的服务代码，然后将结果返回给客户端，反序列化数据给调用方法的过程。
RPC具体调用流程如下所示：
![RPC调用流程](/Users/lx/OneDrive - RLS ,inc/markdown/grpc-go-stack.png)
通用的RPC组件一般包括以下一些模块：
serviceClient：这个模块主要是封装服务端对外提供的API，让客户端像使用本地API接口一样调用远程服务。一般，我们使用动态代理机制，当客户端调用api的方法时，serviceClient会走代理逻辑，去远程服务器请求真正的执行方法，然后将响应结果作为本地的api方法执行结果返回给客户端应用。类似RMI的stub模块。 processor：在服务端存在很多方法，当客户端请求过来，服务端需要定位到具体对象的具体方法，然后执行该方法，这个功能就由processor模块来完成。一般这个操作需要使用反射机制来获取用来执行真实处理逻辑的方法，当然，有的RPC直接在server初始化的时候，将一定规则写进Map映射中，这样直接获取对象即可。类似RMI的skeleton模块。 protocol：协议层，这是每个RPC组件的核心技术所在。一般，协议层包括编码/解码，或者说序列化和反序列化工作；当然，有的时候编解码不仅仅是对象序列化的工作，还有一些通信相关的字节流的额外解析部分。序列化工具有：hessian，protobuf，avro,thrift，json系，xml系等等。在RMI中这块是直接使用JDK自身的序列化组件。 transport：传输层，主要是服务端和客户端网络通信相关的功能。这里和下面的IO层区分开，主要是因为传输层处理server/client的网络通信交互，而不涉及具体底层处理连接请求和响应相关的逻辑。 I/O：这个模块主要是为了提高性能可能采用不同的IO模型和线程模型，当然，一般我们可能和上面的transport层联系的比较紧密，统一称为remote模块。 此外，还有业务代码自己去实现的client和server层。client当需要远程调用服务时，会首先初始化一个API接口代理对象，然后调用某个代理方法。server在对外暴露服务时，需要首先实现对应API接口内部的方法，当请求过来时，通过反射找到对应的实例对象，执行对应的业务代码。
![img](/Users/lx/OneDrive - RLS ,inc/markdown/rpc框架.png)
JSON-RPC 1.JSON-RPC介绍 JSON-RPC是一个无状态且轻量级的RPC协议，其传输内容以JSON方式，相对于一般的HTTP请求通过URI调用远程服务器，JSON-RPC直接在内容中定义了要调用的函数名称（如 {“method”: “getUser”}），对于开发者来说非常的方便。Bitcoin和Ethereum都支持JSON-RPC通过客户端直接调用节点上的函数或方法。 注意: 以rpc开头的方法名预留作为系统扩展，且必须不能用于其他地方。
2.约定 由于JSON-RPC使用JSON，它具有与其相同的类型系统(见http://www.json.org或RFC 4627)。JSON可以表示四个基本类型(String、Numbers、Booleans和Null)和两个结构化类型(Objects和Arrays)。 规范中，术语“Primitive”标记那4种原始类型，“Structured”标记两种结构化类型。任何时候文档涉及JSON数据类型，第一个字母都必须大写：Object，Array，String，Number，Boolean，Null。包括True和False也要大写。
在客户端与任何被匹配到的服务端之间交换的所有成员名字应是区分大小写的。 函数、方法、过程都可以认为是可以互换的。
客户端被定义为请求对象的来源及响应对象的处理程序。
服务端被定义为响应对象的起源和请求对象的处理程序。
该规范的一种实现为可以轻而易举的填补这两个角色,即使是在同一时间,同一客户端或其他不相同的客户端。 该规范不涉及复杂层。
3.JSON-RPC请求 JSON-RPC 2.0和1.0之间一些差异，我们这里介绍2.0的使用，一个JSON-RPC的请求必须包含以下4个字段。
1.jsonrpc: 指定JSON-RPC的版本，必须设置为2.0 2.id: 已建立客户端的唯一标识id，值必须包含一个字符串、数值或NULL空值。如果不包含该成员则被认定为是一个通知。该值一般不为NULL，若为数值则不应该包含小数。 3.method: 包含所要调用方法名称的字符串，以rpc开头的方法名，用英文句号连接的为预留给rpc内部的方法名及扩展名，且不能在其他地方使用。 4.params: 方法传入的参数，若无参数则传入空[] 4.JSON-RPC响应 当发起一个RPC调用时，除通知之外服务端都必须有响应，响应表示为一个JSON对象包含以下几个字段。
1.jsonrpc: 指定JSON-RPC的版本，固定为为2.0 2.id: 调用标识符，用于标示一次远程调用过程，值必须包含一个字符串、数值。 3.result: 如果调用成功则显示响应结果 4.error: 如果调用失败则显示错误的信息，error带有以下几个字段 4.1.code: 使用数值表示该异常的错误类型，必须为整数 【必须】 4.">
    <meta name="twitter:image" content="/images/avatar.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:title" content="Go Rpc">
  <meta property="og:description" content="Rpc (Remote Procedure Call) 远程过程调用RPC, 就是客户端基于某种传输协议通过网络向服务提供端请求服务处理, 然后获取反回数据; 这种调用对于客户端而言和本地调用一样方便, 开发人员不需要了解具体的底层网络传输协议. 简单讲, 就是本地调用的逻辑处理的过程放在远程的机器上.
RPC架构 一般，远程过程调用RPC就是本地动态代理隐藏通信细节，通过组件序列化请求，走网络到服务端，执行真正的服务代码，然后将结果返回给客户端，反序列化数据给调用方法的过程。
RPC具体调用流程如下所示：
![RPC调用流程](/Users/lx/OneDrive - RLS ,inc/markdown/grpc-go-stack.png)
通用的RPC组件一般包括以下一些模块：
serviceClient：这个模块主要是封装服务端对外提供的API，让客户端像使用本地API接口一样调用远程服务。一般，我们使用动态代理机制，当客户端调用api的方法时，serviceClient会走代理逻辑，去远程服务器请求真正的执行方法，然后将响应结果作为本地的api方法执行结果返回给客户端应用。类似RMI的stub模块。 processor：在服务端存在很多方法，当客户端请求过来，服务端需要定位到具体对象的具体方法，然后执行该方法，这个功能就由processor模块来完成。一般这个操作需要使用反射机制来获取用来执行真实处理逻辑的方法，当然，有的RPC直接在server初始化的时候，将一定规则写进Map映射中，这样直接获取对象即可。类似RMI的skeleton模块。 protocol：协议层，这是每个RPC组件的核心技术所在。一般，协议层包括编码/解码，或者说序列化和反序列化工作；当然，有的时候编解码不仅仅是对象序列化的工作，还有一些通信相关的字节流的额外解析部分。序列化工具有：hessian，protobuf，avro,thrift，json系，xml系等等。在RMI中这块是直接使用JDK自身的序列化组件。 transport：传输层，主要是服务端和客户端网络通信相关的功能。这里和下面的IO层区分开，主要是因为传输层处理server/client的网络通信交互，而不涉及具体底层处理连接请求和响应相关的逻辑。 I/O：这个模块主要是为了提高性能可能采用不同的IO模型和线程模型，当然，一般我们可能和上面的transport层联系的比较紧密，统一称为remote模块。 此外，还有业务代码自己去实现的client和server层。client当需要远程调用服务时，会首先初始化一个API接口代理对象，然后调用某个代理方法。server在对外暴露服务时，需要首先实现对应API接口内部的方法，当请求过来时，通过反射找到对应的实例对象，执行对应的业务代码。
![img](/Users/lx/OneDrive - RLS ,inc/markdown/rpc框架.png)
JSON-RPC 1.JSON-RPC介绍 JSON-RPC是一个无状态且轻量级的RPC协议，其传输内容以JSON方式，相对于一般的HTTP请求通过URI调用远程服务器，JSON-RPC直接在内容中定义了要调用的函数名称（如 {“method”: “getUser”}），对于开发者来说非常的方便。Bitcoin和Ethereum都支持JSON-RPC通过客户端直接调用节点上的函数或方法。 注意: 以rpc开头的方法名预留作为系统扩展，且必须不能用于其他地方。
2.约定 由于JSON-RPC使用JSON，它具有与其相同的类型系统(见http://www.json.org或RFC 4627)。JSON可以表示四个基本类型(String、Numbers、Booleans和Null)和两个结构化类型(Objects和Arrays)。 规范中，术语“Primitive”标记那4种原始类型，“Structured”标记两种结构化类型。任何时候文档涉及JSON数据类型，第一个字母都必须大写：Object，Array，String，Number，Boolean，Null。包括True和False也要大写。
在客户端与任何被匹配到的服务端之间交换的所有成员名字应是区分大小写的。 函数、方法、过程都可以认为是可以互换的。
客户端被定义为请求对象的来源及响应对象的处理程序。
服务端被定义为响应对象的起源和请求对象的处理程序。
该规范的一种实现为可以轻而易举的填补这两个角色,即使是在同一时间,同一客户端或其他不相同的客户端。 该规范不涉及复杂层。
3.JSON-RPC请求 JSON-RPC 2.0和1.0之间一些差异，我们这里介绍2.0的使用，一个JSON-RPC的请求必须包含以下4个字段。
1.jsonrpc: 指定JSON-RPC的版本，必须设置为2.0 2.id: 已建立客户端的唯一标识id，值必须包含一个字符串、数值或NULL空值。如果不包含该成员则被认定为是一个通知。该值一般不为NULL，若为数值则不应该包含小数。 3.method: 包含所要调用方法名称的字符串，以rpc开头的方法名，用英文句号连接的为预留给rpc内部的方法名及扩展名，且不能在其他地方使用。 4.params: 方法传入的参数，若无参数则传入空[] 4.JSON-RPC响应 当发起一个RPC调用时，除通知之外服务端都必须有响应，响应表示为一个JSON对象包含以下几个字段。
1.jsonrpc: 指定JSON-RPC的版本，固定为为2.0 2.id: 调用标识符，用于标示一次远程调用过程，值必须包含一个字符串、数值。 3.result: 如果调用成功则显示响应结果 4.error: 如果调用失败则显示错误的信息，error带有以下几个字段 4.1.code: 使用数值表示该异常的错误类型，必须为整数 【必须】 4.">
  <meta property="og:url" content="/post/go-rpc/">
  <meta property="og:image" content="/images/avatar.png">




<meta name="generator" content="Hugo 0.68.3">


<link rel="canonical" href="/post/go-rpc/">

<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="format-detection" content="telephone=no,email=no,adress=no">
<meta http-equiv="Cache-Control" content="no-transform">


<meta name="robots" content="index,follow">
<meta name="referrer" content="origin-when-cross-origin">
<meta name="google-site-verification" content="_moDmnnBNVLBN1rzNxyGUGdPHE20YgbmrtzLIbxaWFc">
<meta name="msvalidate.01" content="22596E34341DD1D17D6022C44647E587">





<meta name="theme-color" content="#02b875">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="Hugo Blog">
<meta name="msapplication-tooltip" content="Hugo Blog">
<meta name='msapplication-navbutton-color' content="#02b875">
<meta name="msapplication-TileColor" content="#02b875">
<meta name="msapplication-TileImage" content="/icons/icon-144x144.png">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/icons/icon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/icons/icon-32x32.png">
<link rel="icon" sizes="192x192" href="/icons/icon-192x192.png">
<link rel="apple-touch-icon" href="/icons/icon-152x152.png">
<link rel="manifest" href="/manifest.json">


<link rel="preload" href="/styles/main-rendered.min.css" as="style">


<link rel="preload" href="https://fonts.googleapis.com/css?family=Lobster" as="style">
<link rel="preload" href="/images/avatar.png" as="image">
<link rel="preload" href="/images/grey-prism.svg" as="image">


<style>
  body {
    background: rgb(244, 243, 241) url('/images/grey-prism.svg') repeat fixed;
  }
</style>
<link rel="stylesheet" href="/styles/main-rendered.min.css">


<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lobster">



<script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.2/dist/medium-zoom.min.js"></script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video-js.min.css">



  
  
<!--[if lte IE 8]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-ie8@1.1.2/dist/videojs-ie8.min.js"></script>
<![endif]-->

<!--[if lte IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20180112/classList.min.js"></script>
<![endif]-->


</head>
  <body>
    <div class="suspension">
      <a role="button" aria-label="Go to top" title="Go to top" class="to-top is-hide"><span class="icon icon-up" aria-hidden="true"></span></a>
      
        
	<a role="button" aria-label="Go to comments" title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment" aria-hidden="true"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <a href=""><img class="avatar" src="/images/avatar.png" alt="Avatar"></a>
  
  <h2 class="title"><a href="">Hugo Blog</a></h2>
  
  <p class="subtitle">~ Keep It Simple &amp; Stupid ~</p>
  <button class="menu-toggle" type="button" aria-label="Main Menu" aria-expanded="false" tab-index="0">
    <span class="icon icon-menu" aria-hidden="true"></span>
  </button>

  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
          
          
           is-active">
          <a href="/">Home</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="https://github.com/laozhu">Works</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="menu-item
          
          
          ">
          <a href="/links/">Links</a>
        </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list"><li class="social-item">
          <a href="mailto:name@domain.com" title="Email" aria-label="Email">
            <span class="icon icon-email" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//github.com/github_username" rel="me" title="GitHub" aria-label="GitHub">
	    <span class="icon icon-github" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//twitter.com/twitter_username" rel="me" title="Twitter" aria-label="Twitter">
            <span class="icon icon-twitter" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//weibo.com/weibo_username" rel="me" title="Weibo" aria-label="Weibo">
            <span class="icon icon-weibo" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="/images/qrcode.jpg" rel="me" title="Wechat" aria-label="Wechat">
            <span class="icon icon-wechat" aria-hidden="true"></span>
          </a>
        </li><li class="social-item">
          <a href="//www.linkedin.com/in/linkedin_username" rel="me" title="LinkedIn" aria-label="LinkedIn">
            <span class="icon icon-linkedin" aria-hidden="true"></span>
          </a>
        </li></ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Go Rpc</h1>
      <p class="post-meta">@Ritchie Zhu · Mar 20, 2020 · 15 min read</p>
    </header>
    <article class="post-content"><h2 id="rpc-remote-procedure-call">Rpc (Remote Procedure Call)</h2>
<p>远程过程调用RPC, 就是客户端基于某种传输协议通过网络向服务提供端请求服务处理, 然后获取反回数据; 这种调用对于客户端而言和本地调用一样方便, 开发人员不需要了解具体的底层网络传输协议. 简单讲, 就是本地调用的逻辑处理的过程放在远程的机器上.</p>
<h4 id="rpc架构">RPC架构</h4>
<p>一般，远程过程调用RPC就是本地动态代理隐藏通信细节，通过组件序列化请求，走网络到服务端，执行真正的服务代码，然后将结果返回给客户端，反序列化数据给调用方法的过程。</p>
<p><strong>RPC具体调用流程如下所示：</strong></p>
<p>![RPC调用流程](/Users/lx/OneDrive - RLS ,inc/markdown/grpc-go-stack.png)</p>
<p><strong>通用的RPC组件一般包括以下一些模块：</strong></p>
<pre><code>serviceClient：这个模块主要是封装服务端对外提供的API，让客户端像使用本地API接口一样调用远程服务。一般，我们使用动态代理机制，当客户端调用api的方法时，serviceClient会走代理逻辑，去远程服务器请求真正的执行方法，然后将响应结果作为本地的api方法执行结果返回给客户端应用。类似RMI的stub模块。
processor：在服务端存在很多方法，当客户端请求过来，服务端需要定位到具体对象的具体方法，然后执行该方法，这个功能就由processor模块来完成。一般这个操作需要使用反射机制来获取用来执行真实处理逻辑的方法，当然，有的RPC直接在server初始化的时候，将一定规则写进Map映射中，这样直接获取对象即可。类似RMI的skeleton模块。
protocol：协议层，这是每个RPC组件的核心技术所在。一般，协议层包括编码/解码，或者说序列化和反序列化工作；当然，有的时候编解码不仅仅是对象序列化的工作，还有一些通信相关的字节流的额外解析部分。序列化工具有：hessian，protobuf，avro,thrift，json系，xml系等等。在RMI中这块是直接使用JDK自身的序列化组件。
transport：传输层，主要是服务端和客户端网络通信相关的功能。这里和下面的IO层区分开，主要是因为传输层处理server/client的网络通信交互，而不涉及具体底层处理连接请求和响应相关的逻辑。
I/O：这个模块主要是为了提高性能可能采用不同的IO模型和线程模型，当然，一般我们可能和上面的transport层联系的比较紧密，统一称为remote模块。
</code></pre><p>此外，还有业务代码自己去实现的client和server层。client当需要远程调用服务时，会首先初始化一个API接口代理对象，然后调用某个代理方法。server在对外暴露服务时，需要首先实现对应API接口内部的方法，当请求过来时，通过反射找到对应的实例对象，执行对应的业务代码。</p>
<p>![img](/Users/lx/OneDrive - RLS ,inc/markdown/rpc框架.png)</p>
<h4 id="json-rpc">JSON-RPC</h4>
<h5 id="1json-rpc介绍">1.JSON-RPC介绍</h5>
<p>JSON-RPC是一个无状态且轻量级的RPC协议，其传输内容以JSON方式，相对于一般的HTTP请求通过URI调用远程服务器，JSON-RPC直接在内容中定义了要调用的函数名称（如 {“method”: “getUser”}），对于开发者来说非常的方便。Bitcoin和Ethereum都支持JSON-RPC通过客户端直接调用节点上的函数或方法。
注意: 以rpc开头的方法名预留作为系统扩展，且必须不能用于其他地方。</p>
<h5 id="2约定">2.约定</h5>
<p>由于JSON-RPC使用JSON，它具有与其相同的类型系统(见<a href="http://www.json.org/">http://www.json.org</a>或<a href="http://www.ietf.org/rfc/rfc4627.txt">RFC 4627</a>)。JSON可以表示四个基本类型(String、Numbers、Booleans和Null)和两个结构化类型(Objects和Arrays)。 规范中，术语“Primitive”标记那4种原始类型，“Structured”标记两种结构化类型。任何时候文档涉及JSON数据类型，第一个字母都必须大写：Object，Array，String，Number，Boolean，Null。包括True和False也要大写。</p>
<p>在客户端与任何被匹配到的服务端之间交换的所有成员名字应是区分大小写的。 函数、方法、过程都可以认为是可以互换的。</p>
<p>客户端被定义为请求对象的来源及响应对象的处理程序。</p>
<p>服务端被定义为响应对象的起源和请求对象的处理程序。</p>
<p>该规范的一种实现为可以轻而易举的填补这两个角色,即使是在同一时间,同一客户端或其他不相同的客户端。 该规范不涉及复杂层。</p>
<h5 id="3json-rpc请求">3.JSON-RPC请求</h5>
<p>JSON-RPC 2.0和1.0之间一些差异，我们这里介绍2.0的使用，一个JSON-RPC的请求必须包含以下4个字段。</p>
<pre><code>1.jsonrpc: 指定JSON-RPC的版本，必须设置为2.0
2.id: 已建立客户端的唯一标识id，值必须包含一个字符串、数值或NULL空值。如果不包含该成员则被认定为是一个通知。该值一般不为NULL，若为数值则不应该包含小数。
3.method: 包含所要调用方法名称的字符串，以rpc开头的方法名，用英文句号连接的为预留给rpc内部的方法名及扩展名，且不能在其他地方使用。
4.params: 方法传入的参数，若无参数则传入空[]
</code></pre><h5 id="4json-rpc响应">4.JSON-RPC响应</h5>
<p>当发起一个RPC调用时，除通知之外服务端都必须有响应，响应表示为一个JSON对象包含以下几个字段。</p>
<pre><code>1.jsonrpc: 指定JSON-RPC的版本，固定为为2.0
2.id: 调用标识符，用于标示一次远程调用过程，值必须包含一个字符串、数值。
3.result: 如果调用成功则显示响应结果
4.error: 如果调用失败则显示错误的信息，error带有以下几个字段
	4.1.code: 使用数值表示该异常的错误类型，必须为整数 【必须】
	4.2.message: 对该错误的简单描述字符串。 该描述应尽量限定在简短的一句话 【必须】
	4.3.data: 包含关于错误附加信息的基本类型或结构化类型 【可选】
</code></pre><h5 id="5json-rpc错误码">5.JSON-RPC错误码</h5>
<pre><code>-32700: Parse error语法解析错误 (服务端接收到无效的json。该错误发送于服务器尝试解析json文本)
-32600: Invalid Request (发送的json不是一个有效的请求对象)
-32601: Method not found (该方法不存在或无效)
-32602: Invalid params (无效的方法参数)
-32603: Internal error (JSON-RPC内部错误)
-32000 ~ -32099: Server error (预留用于自定义的服务器错误)
-32768 ~ -32000: 保留的预定义错误代码, 保留下列以供将来使用
</code></pre><h5 id="6批量调用">6.批量调用</h5>
<p>当需要同时发送多个请求对象时，客户端可以发送一个包含所有请求对象的数组。</p>
<p>当批量调用的所有请求对象处理完成时，服务端则需要返回一个包含相对应的响应对象数组。每个响应对象都应对应每个请求对象，除非是通知的请求对象。服务端可以并发的，以任意顺序和任意宽度的并行性来处理这些批量调用。</p>
<p>这些相应的响应对象可以任意顺序的包含在返回的数组中，而客户端应该是基于各个响应对象中的id成员来匹配对应的请求对象。</p>
<p>若批量调用的rpc操作本身非一个有效json或一个至少包含一个值的数组，则服务端返回的将单单是一个响应对象而非数组。若批量调用没有需要返回的响应对象，则服务端不需要返回任何结果且必须不能返回一个空数组给客户端。</p>
<h5 id="7示例">7.示例</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#960050;background-color:#1e0010">带索引数组参数的rpc调用</span>
<span style="color:#960050;background-color:#1e0010">--&gt;</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;subtract&#34;</span>, <span style="color:#f92672">&#34;params&#34;</span>: [<span style="color:#ae81ff">42</span>, <span style="color:#ae81ff">23</span>], <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">1</span>}
<span style="color:#960050;background-color:#1e0010">&lt;--</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;result&#34;</span>: <span style="color:#ae81ff">19</span>, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">1</span>}

<span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#960050;background-color:#1e0010">带关联数组参数的rpc调用</span>
<span style="color:#960050;background-color:#1e0010">--&gt;</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;subtract&#34;</span>, <span style="color:#f92672">&#34;params&#34;</span>: {<span style="color:#f92672">&#34;subtrahend&#34;</span>: <span style="color:#ae81ff">23</span>, <span style="color:#f92672">&#34;minuend&#34;</span>: <span style="color:#ae81ff">42</span>}, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">3</span>}
<span style="color:#960050;background-color:#1e0010">&lt;--</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;result&#34;</span>: <span style="color:#ae81ff">19</span>, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#ae81ff">3</span>}

<span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#960050;background-color:#1e0010">rpc批量调用</span>
<span style="color:#960050;background-color:#1e0010">--&gt;</span> [{<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;sum&#34;</span>, <span style="color:#f92672">&#34;params&#34;</span>: [<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">4</span>], <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>},
     {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;notify_hello&#34;</span>, <span style="color:#f92672">&#34;params&#34;</span>: [<span style="color:#ae81ff">7</span>]},
     {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;subtract&#34;</span>, <span style="color:#f92672">&#34;params&#34;</span>: [<span style="color:#ae81ff">42</span>,<span style="color:#ae81ff">23</span>], <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;2&#34;</span>},
     {<span style="color:#f92672">&#34;foo&#34;</span>: <span style="color:#e6db74">&#34;boo&#34;</span>},
     {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;foo.get&#34;</span>, <span style="color:#f92672">&#34;params&#34;</span>: {<span style="color:#f92672">&#34;name&#34;</span>: <span style="color:#e6db74">&#34;myself&#34;</span>}, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>},
     {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;get_data&#34;</span>, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;9&#34;</span>}]
<span style="color:#960050;background-color:#1e0010">&lt;--</span> [{<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;result&#34;</span>: <span style="color:#ae81ff">7</span>, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>},
     {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;result&#34;</span>: <span style="color:#ae81ff">19</span>, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;2&#34;</span>},
     {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;error&#34;</span>: {<span style="color:#f92672">&#34;code&#34;</span>: <span style="color:#ae81ff">-32600</span>, <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Invalid Request&#34;</span>}, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#66d9ef">null</span>},
     {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;error&#34;</span>: {<span style="color:#f92672">&#34;code&#34;</span>: <span style="color:#ae81ff">-32601</span>, <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Method not found&#34;</span>}, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;5&#34;</span>},
     {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;result&#34;</span>: [<span style="color:#e6db74">&#34;hello&#34;</span>, <span style="color:#ae81ff">5</span>], <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;9&#34;</span>}]
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#960050;background-color:#1e0010">不包含调用方法的rpc调用</span>
<span style="color:#960050;background-color:#1e0010">--&gt;</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;foobar&#34;</span>, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>}
<span style="color:#960050;background-color:#1e0010">&lt;--</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;error&#34;</span>: {<span style="color:#f92672">&#34;code&#34;</span>: <span style="color:#ae81ff">-32601</span>, <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Method not found&#34;</span>}, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#e6db74">&#34;1&#34;</span>}

<span style="color:#ae81ff">2</span><span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#960050;background-color:#1e0010">包含无效json的rpc调用</span>
<span style="color:#960050;background-color:#1e0010">--&gt;</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#e6db74">&#34;foobar, &#34;</span><span style="color:#960050;background-color:#1e0010">params</span><span style="color:#e6db74">&#34;: &#34;</span><span style="color:#960050;background-color:#1e0010">bar</span><span style="color:#e6db74">&#34;, &#34;</span><span style="color:#960050;background-color:#1e0010">baz]</span>
<span style="color:#960050;background-color:#1e0010">&lt;--</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;error&#34;</span>: {<span style="color:#f92672">&#34;code&#34;</span>: <span style="color:#ae81ff">-32700</span>, <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Parse error&#34;</span>}, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#66d9ef">null</span>}

<span style="color:#ae81ff">3</span><span style="color:#960050;background-color:#1e0010">.</span> <span style="color:#960050;background-color:#1e0010">无效请求对象的rpc调用</span>
<span style="color:#960050;background-color:#1e0010">--&gt;</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;method&#34;</span>: <span style="color:#ae81ff">1</span>, <span style="color:#f92672">&#34;params&#34;</span>: <span style="color:#e6db74">&#34;bar&#34;</span>}
<span style="color:#960050;background-color:#1e0010">&lt;--</span> {<span style="color:#f92672">&#34;jsonrpc&#34;</span>: <span style="color:#e6db74">&#34;2.0&#34;</span>, <span style="color:#f92672">&#34;error&#34;</span>: {<span style="color:#f92672">&#34;code&#34;</span>: <span style="color:#ae81ff">-32600</span>, <span style="color:#f92672">&#34;message&#34;</span>: <span style="color:#e6db74">&#34;Invalid Request&#34;</span>}, <span style="color:#f92672">&#34;id&#34;</span>: <span style="color:#66d9ef">null</span>}
</code></pre></div><h5 id="8源码分析">8.源码分析</h5>
<h6 id="1jsonrpc_servergo"><strong>1.jsonrpc_server.go</strong></h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;errors&#34;</span>
	<span style="color:#e6db74">&#34;net&#34;</span>
	<span style="color:#e6db74">&#34;net/rpc&#34;</span>
	<span style="color:#e6db74">&#34;net/rpc/jsonrpc&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Args</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">A</span>, <span style="color:#a6e22e">B</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Quotient</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Quo</span>, <span style="color:#a6e22e">Rem</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Arith</span> <span style="color:#66d9ef">int</span>

<span style="color:#75715e">//Multiply 实现乘方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Arith</span>) <span style="color:#a6e22e">Multiply</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Args</span>, <span style="color:#a6e22e">reply</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">int</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#f92672">*</span><span style="color:#a6e22e">reply</span> = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">A</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">B</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#75715e">//Divide 实现除方法
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Arith</span>) <span style="color:#a6e22e">Divide</span>(<span style="color:#a6e22e">args</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Args</span>, <span style="color:#a6e22e">quo</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Quotient</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">B</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;divide by zero&#34;</span>)
	}
	<span style="color:#a6e22e">quo</span>.<span style="color:#a6e22e">Quo</span> = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">A</span> <span style="color:#f92672">/</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">B</span>
	<span style="color:#a6e22e">quo</span>.<span style="color:#a6e22e">Rem</span> = <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">A</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">B</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {

	<span style="color:#a6e22e">arith</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">Arith</span>)
	<span style="color:#a6e22e">rpc</span>.<span style="color:#a6e22e">Register</span>(<span style="color:#a6e22e">arith</span>)

	<span style="color:#75715e">// err := http.ListenAndServe(&#34;:1234&#34;, nil)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// if err != nil {
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	fmt.Println(err.Error())
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// }
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">listener</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listen</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#e6db74">&#34;:1234&#34;</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">listener</span>.<span style="color:#a6e22e">Accept</span>()	<span style="color:#75715e">//监听client请求
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">continue</span>
		}
		<span style="color:#a6e22e">jsonrpc</span>.<span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span>)
	}
}
</code></pre></div><p>![](/Users/lx/OneDrive - RLS ,inc/markdown/rpc-server.png)</p>
<p>整体分三部分，第一部分注册服务器定义的方法，第二部分监听客户端的请求，解析获取到客户端的请求参数。第三部分拿到请求参数执行服务器的调用函数，将返回结果返回给客户端。</p>
<p>整个过程其实可以对比是一次socket的调用过程。</p>
<p>Server存储服务器的service以及其请求的Request和Response，如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ServiceMethod</span> <span style="color:#66d9ef">string</span>   <span style="color:#75715e">// format: &#34;Service.Method&#34;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Seq</span>           <span style="color:#66d9ef">uint64</span>   <span style="color:#75715e">// sequence number chosen by client
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">next</span>          <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span> <span style="color:#75715e">// for free list in Server
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Response</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ServiceMethod</span> <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// echoes that of the Request
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Seq</span>           <span style="color:#66d9ef">uint64</span>    <span style="color:#75715e">// echoes that of the request
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Error</span>         <span style="color:#66d9ef">string</span>    <span style="color:#75715e">// error, if any.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">next</span>          <span style="color:#f92672">*</span><span style="color:#a6e22e">Response</span> <span style="color:#75715e">// for free list in Server
</span><span style="color:#75715e"></span>}
</code></pre></div><p>service 存储服务器需要注册的方法，methodType就是具体方法的属性。</p>
<p>所以要想客户端进行远程调用服务器的方法，前提是在调用之前，服务器的方法均已加载在Server结构体中，所以需要服务器显示的调用register方法，下面看一下里面核心的代码:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">register</span>(<span style="color:#a6e22e">rcvr</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">name</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">useName</span> <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">service</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">typ</span> = <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">rcvr</span>)
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">rcvr</span> = <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">ValueOf</span>(<span style="color:#a6e22e">rcvr</span>)
	<span style="color:#a6e22e">sname</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Indirect</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">rcvr</span>).<span style="color:#a6e22e">Type</span>().<span style="color:#a6e22e">Name</span>()
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">name</span> = <span style="color:#a6e22e">sname</span>

	<span style="color:#75715e">// Install the methods
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">method</span> = <span style="color:#a6e22e">suitableMethods</span>(<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">typ</span>, <span style="color:#66d9ef">true</span>)

	<span style="color:#f92672">...</span>
    
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">dup</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">serviceMap</span>.<span style="color:#a6e22e">LoadOrStore</span>(<span style="color:#a6e22e">sname</span>, <span style="color:#a6e22e">s</span>); <span style="color:#a6e22e">dup</span> {
		<span style="color:#f92672">...</span>   
	}
    <span style="color:#f92672">...</span>
}


<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">suitableMethods</span>(<span style="color:#a6e22e">typ</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>, <span style="color:#a6e22e">reportErr</span> <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">methodType</span> {
	<span style="color:#a6e22e">methods</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">methodType</span>)
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">m</span> &lt; <span style="color:#a6e22e">typ</span>.<span style="color:#a6e22e">NumMethod</span>(); <span style="color:#a6e22e">m</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">method</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">typ</span>.<span style="color:#a6e22e">Method</span>(<span style="color:#a6e22e">m</span>)
		<span style="color:#a6e22e">mtype</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Type</span>
		<span style="color:#a6e22e">mname</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Name</span>
		
		<span style="color:#a6e22e">argType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mtype</span>.<span style="color:#a6e22e">In</span>(<span style="color:#ae81ff">1</span>)
		
        <span style="color:#f92672">...</span>
	
		<span style="color:#a6e22e">replyType</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mtype</span>.<span style="color:#a6e22e">In</span>(<span style="color:#ae81ff">2</span>)
		
        <span style="color:#f92672">...</span>
        
		<span style="color:#a6e22e">methods</span>[<span style="color:#a6e22e">mname</span>] = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">methodType</span>{<span style="color:#a6e22e">method</span>: <span style="color:#a6e22e">method</span>, <span style="color:#a6e22e">ArgType</span>: <span style="color:#a6e22e">argType</span>, <span style="color:#a6e22e">ReplyType</span>: <span style="color:#a6e22e">replyType</span>}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">methods</span>
}
</code></pre></div><p>这段代码就是通过反射把结构体实现的方法的一些属性获取到，包括本身可执行的方法对象、名称、请求参数、返回参数。</p>
<p>最终存储到server的serviceMap中。 客户端调用服务器的方法的结构为 struct.method(&ldquo;Arith.Multiply&rdquo;)，这样只需要按 . 进行分割，拿到struct名称和method名称则可以通过再serviceMap获取到方法，执行获得结果。</p>
<p>注册完方法后，接下来就是监听客户端的请求了。</p>
<p><strong>2.Accept</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">Accept</span>(<span style="color:#a6e22e">lis</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Listener</span>) {
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">lis</span>.<span style="color:#a6e22e">Accept</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;rpc.Serve: accept:&#34;</span>, <span style="color:#a6e22e">err</span>.<span style="color:#a6e22e">Error</span>())
			<span style="color:#66d9ef">return</span>
		}
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span>)
}
</code></pre></div><p>通过 net 包中的监听tcp端口，然后起了一个协程</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">ServeConn</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadWriteCloser</span>) {
	<span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">gobServerCodec</span>{
		<span style="color:#a6e22e">rwc</span>:    <span style="color:#a6e22e">conn</span>,
		<span style="color:#a6e22e">dec</span>:    <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">conn</span>),
		<span style="color:#a6e22e">enc</span>:    <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">buf</span>),
		<span style="color:#a6e22e">encBuf</span>: <span style="color:#a6e22e">buf</span>,
	}
	<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">ServeCodec</span>(<span style="color:#a6e22e">srv</span>)
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">ServeCodec</span>(<span style="color:#a6e22e">codec</span> <span style="color:#a6e22e">ServerCodec</span>) {
	<span style="color:#a6e22e">sending</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>)
	<span style="color:#a6e22e">wg</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>)
	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">mtype</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">argv</span>, <span style="color:#a6e22e">replyv</span>, <span style="color:#a6e22e">keepReading</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">codec</span>)
		
       <span style="color:#f92672">...</span>
       
		<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">service</span>.<span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">server</span>, <span style="color:#a6e22e">sending</span>, <span style="color:#a6e22e">wg</span>, <span style="color:#a6e22e">mtype</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">argv</span>, <span style="color:#a6e22e">replyv</span>, <span style="color:#a6e22e">codec</span>)
	}
  <span style="color:#f92672">...</span>
}
</code></pre></div><p>ServeConn 将gob序列化的方法和conn保存到gobServerCodec结构体，然后调用了server.ServeCodec方法，这个方式做的事情就是将客户端传过来的包解析序列化解析，将请求参数，待返回的变量，以及是调服务器哪个方法，这些均在上面的 server.readRequest方法处理。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">readRequest</span>(<span style="color:#a6e22e">codec</span> <span style="color:#a6e22e">ServerCodec</span>) (<span style="color:#a6e22e">service</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">mtype</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">methodType</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">argv</span>, <span style="color:#a6e22e">replyv</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Value</span>, <span style="color:#a6e22e">keepReading</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {

	<span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">mtype</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">keepReading</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">readRequestHeader</span>(<span style="color:#a6e22e">codec</span>)
	<span style="color:#f92672">...</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>) <span style="color:#a6e22e">readRequestHeader</span>(<span style="color:#a6e22e">codec</span> <span style="color:#a6e22e">ServerCodec</span>) (<span style="color:#a6e22e">svc</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>, <span style="color:#a6e22e">mtype</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">methodType</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">keepReading</span> <span style="color:#66d9ef">bool</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#75715e">// Grab the request header.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">req</span> = <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">getRequest</span>()
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">dot</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">LastIndex</span>(<span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">ServiceMethod</span>, <span style="color:#e6db74">&#34;.&#34;</span>)
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">serviceName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">ServiceMethod</span>[:<span style="color:#a6e22e">dot</span>]
	<span style="color:#a6e22e">methodName</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">ServiceMethod</span>[<span style="color:#a6e22e">dot</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]

	<span style="color:#75715e">// Look up the request.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">svci</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">serviceMap</span>.<span style="color:#a6e22e">Load</span>(<span style="color:#a6e22e">serviceName</span>)
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">svc</span> = <span style="color:#a6e22e">svci</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>)
	<span style="color:#a6e22e">mtype</span> = <span style="color:#a6e22e">svc</span>.<span style="color:#a6e22e">method</span>[<span style="color:#a6e22e">methodName</span>]
	<span style="color:#f92672">...</span>
	}
	<span style="color:#66d9ef">return</span>
}
</code></pre></div><p>核心的功能在 readRequestHeader 中，做的一件事就是将客户端传过来的 struct.method，按 . 进行分割，然后拿到serviceName和methodName，然后再去server.serviceMap中拿到具体的服务和方法执行对象。</p>
<p>拿到结果之后，会起一个协程，调service.call方法，这里面做的事情就是执行服务器服务的方法，拿到返回结果，再调用WriteReponse，将数据写回去。然后客户端的 input 方法循环获取结果。这样形成闭环。</p>
<p>下面看看service.call方法:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">service</span>) <span style="color:#a6e22e">call</span>(<span style="color:#a6e22e">server</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Server</span>, <span style="color:#a6e22e">sending</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>, <span style="color:#a6e22e">wg</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">WaitGroup</span>, <span style="color:#a6e22e">mtype</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">methodType</span>, <span style="color:#a6e22e">req</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">argv</span>, <span style="color:#a6e22e">replyv</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Value</span>, <span style="color:#a6e22e">codec</span> <span style="color:#a6e22e">ServerCodec</span>) {
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">function</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mtype</span>.<span style="color:#a6e22e">method</span>.<span style="color:#a6e22e">Func</span>
	<span style="color:#a6e22e">returnValues</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">function</span>.<span style="color:#a6e22e">Call</span>([]<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Value</span>{<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">rcvr</span>, <span style="color:#a6e22e">argv</span>, <span style="color:#a6e22e">replyv</span>})
	<span style="color:#f92672">...</span>
	<span style="color:#a6e22e">server</span>.<span style="color:#a6e22e">sendResponse</span>(<span style="color:#a6e22e">sending</span>, <span style="color:#a6e22e">req</span>, <span style="color:#a6e22e">replyv</span>.<span style="color:#a6e22e">Interface</span>(), <span style="color:#a6e22e">codec</span>, <span style="color:#a6e22e">errmsg</span>)
	<span style="color:#f92672">...</span>
}
</code></pre></div><p>实现的功能跟上面分析的一样，通过mtype拿到函数对象，然后调用反射的Call方法执行得到结果，最后调用server.sendResponse发送发回结果。</p>
<h6 id="2jsonrpc_clientgo"><strong>2.jsonrpc_client.go</strong></h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
	<span style="color:#e6db74">&#34;fmt&#34;</span>
	<span style="color:#e6db74">&#34;log&#34;</span>
	<span style="color:#e6db74">&#34;net/rpc/jsonrpc&#34;</span>
)

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Args</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">A</span>, <span style="color:#a6e22e">B</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Quotient</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Quo</span>, <span style="color:#a6e22e">Rem</span> <span style="color:#66d9ef">int</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#75715e">// if len(os.Args) != 2 {
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	fmt.Println(&#34;Usage: &#34;, os.Args[0], &#34;server&#34;)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// 	os.Exit(1)
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// }
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">serverAddress</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;127.0.0.1&#34;</span>

	<span style="color:#a6e22e">client</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">jsonrpc</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#e6db74">&#34;tcp&#34;</span>, <span style="color:#a6e22e">serverAddress</span><span style="color:#f92672">+</span><span style="color:#e6db74">&#34;:1234&#34;</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;dialing:&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#75715e">// Synchronous call
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">args</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">Args</span>{<span style="color:#ae81ff">17</span>, <span style="color:#ae81ff">8</span>}
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#e6db74">&#34;Arith.Multiply&#34;</span>, <span style="color:#a6e22e">args</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">reply</span>)	<span style="color:#75715e">//调用乘方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;arith error:&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Arith: %d*%d=%d\n&#34;</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">A</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">B</span>, <span style="color:#a6e22e">reply</span>)

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">quot</span> <span style="color:#a6e22e">Quotient</span>
	<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Call</span>(<span style="color:#e6db74">&#34;Arith.Divide&#34;</span>, <span style="color:#a6e22e">args</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">quot</span>)	<span style="color:#75715e">//调用除方法
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;arith error:&#34;</span>, <span style="color:#a6e22e">err</span>)
	}
	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Arith: %d/%d=%d remainder %d\n&#34;</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">A</span>, <span style="color:#a6e22e">args</span>.<span style="color:#a6e22e">B</span>, <span style="color:#a6e22e">quot</span>.<span style="color:#a6e22e">Quo</span>, <span style="color:#a6e22e">quot</span>.<span style="color:#a6e22e">Rem</span>)

}
</code></pre></div><p>![](/Users/lx/OneDrive - RLS ,inc/markdown/rpc-client.png)</p>
<p><strong>1.Dial and DialHTTP</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Dial connects to an RPC server at the specified network address.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">address</span> <span style="color:#66d9ef">string</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Dial</span>(<span style="color:#a6e22e">network</span>, <span style="color:#a6e22e">address</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">conn</span>), <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p><code>Dial</code> 建立在 net.Dial 上，返回一个client对象，<code>DialHTTP</code> 跟<code>Dial</code>类似，只不过多了一些HTTP的处理，最终都是返回 NewClient(conn)。</p>
<p><strong>2.NewClient</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewClient</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadWriteCloser</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span> {
	<span style="color:#a6e22e">encBuf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">conn</span>)
	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">gobClientCodec</span>{<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewDecoder</span>(<span style="color:#a6e22e">conn</span>), <span style="color:#a6e22e">gob</span>.<span style="color:#a6e22e">NewEncoder</span>(<span style="color:#a6e22e">encBuf</span>), <span style="color:#a6e22e">encBuf</span>}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">NewClientWithCodec</span>(<span style="color:#a6e22e">client</span>)
}

<span style="color:#75715e">// NewClientWithCodec is like NewClient but uses the specified
</span><span style="color:#75715e">// codec to encode requests and decode responses.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewClientWithCodec</span>(<span style="color:#a6e22e">codec</span> <span style="color:#a6e22e">ClientCodec</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span> {
	<span style="color:#a6e22e">client</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Client</span>{
		<span style="color:#a6e22e">codec</span>:   <span style="color:#a6e22e">codec</span>,
		<span style="color:#a6e22e">pending</span>: make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">uint64</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">Call</span>),
	}
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">input</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">client</span>
}
</code></pre></div><p><code>NewClient</code> 里做了2件事，第一件事是生成client结构体对象，包括序列化方式，初始化其中对象等等，Go Rpc默认采用的是gob序列化，但也可以用json或者protobuf。第二件事是启动一个goroutine协程，调用了 <code>input</code> 方法.</p>
<p><strong>3.<code>Call</code> and <code>Go</code> 上面例子中，生成client对象后，会显式的调用<code>Call</code> 或 <code>Go</code>，表示同步调用和异步调用。</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">Go</span>(<span style="color:#a6e22e">serviceMethod</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">done</span> <span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Call</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Call</span> {
	<span style="color:#a6e22e">call</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">Call</span>)
	<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">ServiceMethod</span> = <span style="color:#a6e22e">serviceMethod</span>
	<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Args</span> = <span style="color:#a6e22e">args</span>
	<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Reply</span> = <span style="color:#a6e22e">reply</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">done</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">done</span> = make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Call</span>, <span style="color:#ae81ff">10</span>) <span style="color:#75715e">// buffered.
</span><span style="color:#75715e"></span>	} <span style="color:#66d9ef">else</span> {
		<span style="color:#66d9ef">if</span> cap(<span style="color:#a6e22e">done</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Panic</span>(<span style="color:#e6db74">&#34;rpc: done channel is unbuffered&#34;</span>)
		}
	}
	<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Done</span> = <span style="color:#a6e22e">done</span>
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">call</span>)
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">call</span>
}

<span style="color:#75715e">// Call invokes the named function, waits for it to complete, and returns its error status.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">Call</span>(<span style="color:#a6e22e">serviceMethod</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">args</span> <span style="color:#66d9ef">interface</span>{}, <span style="color:#a6e22e">reply</span> <span style="color:#66d9ef">interface</span>{}) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">call</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">Go</span>(<span style="color:#a6e22e">serviceMethod</span>, <span style="color:#a6e22e">args</span>, <span style="color:#a6e22e">reply</span>, make(<span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Call</span>, <span style="color:#ae81ff">1</span>)).<span style="color:#a6e22e">Done</span>
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Error</span>
}
</code></pre></div><p>可以看到，<code>client.Call</code> 方法其实也是调用<code>client.Go</code>，只不过通过<code>chan</code>进行阻塞。</p>
<p>生成一个Call的结构体，将服务器的调用方法、参数、返回参数，调用结束标记进行组装，然后调用<code>client.send</code>的方法，将call结构体发给服务器。服务器拿到这些参数后，会通过反射出具体的方法，然后执行对应的函数。 下面是<code>Call</code>结构体的定义：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Call 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Call</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">ServiceMethod</span> <span style="color:#66d9ef">string</span>      <span style="color:#75715e">// The name of the service and method to call. 服务方法名
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Args</span>          <span style="color:#66d9ef">interface</span>{} <span style="color:#75715e">// The argument to the function (*struct). 请求参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Reply</span>         <span style="color:#66d9ef">interface</span>{} <span style="color:#75715e">// The reply from the function (*struct). 返回参数
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Error</span>         <span style="color:#66d9ef">error</span>       <span style="color:#75715e">// After completion, the error status. 错误状态
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Done</span>          <span style="color:#66d9ef">chan</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Call</span>  <span style="color:#75715e">// Strobes when call is complete. 
</span><span style="color:#75715e"></span>}
</code></pre></div><p><strong>4.client.send</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">send</span>(<span style="color:#a6e22e">call</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Call</span>) {
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">reqMutex</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">reqMutex</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">// Register this call.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">shutdown</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">closing</span> {
		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>()
		<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Error</span> = <span style="color:#a6e22e">ErrShutdown</span>
		<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">done</span>()
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#a6e22e">seq</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">seq</span>
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">seq</span><span style="color:#f92672">++</span>
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">pending</span>[<span style="color:#a6e22e">seq</span>] = <span style="color:#a6e22e">call</span>
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">// Encode and send the request.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">Seq</span> = <span style="color:#a6e22e">seq</span>
	<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">ServiceMethod</span> = <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">ServiceMethod</span>
	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">WriteRequest</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">request</span>, <span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Args</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>()
		<span style="color:#a6e22e">call</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">pending</span>[<span style="color:#a6e22e">seq</span>]
		delete(<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">pending</span>, <span style="color:#a6e22e">seq</span>)
		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>()
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">call</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">Error</span> = <span style="color:#a6e22e">err</span>
			<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">done</span>()
		}
	}
}
</code></pre></div><p>send 方法是将刚才的<code>call</code>结构体中的信息发给服务器，首先数据不是直接发给服务器的，而是将请求参数和服务器的方法先赋值给client结构体中的Request结构体，同时在赋值的过程需要加锁。然后再调用Gob的WriteRequest方法，将数据刷到缓存区。</p>
<p><strong>5.<code>client.input</code> <code>client.send</code>方法是将数据发给Server，而input则相反，获取Server的返回结果Response给客户端。</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">client</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Client</span>) <span style="color:#a6e22e">input</span>() {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">response</span> <span style="color:#a6e22e">Response</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">response</span> = <span style="color:#a6e22e">Response</span>{}
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">ReadResponseHeader</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">response</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">break</span>
		}
		<span style="color:#a6e22e">seq</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">Seq</span>
		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Lock</span>()
		<span style="color:#a6e22e">call</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">pending</span>[<span style="color:#a6e22e">seq</span>]
		delete(<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">pending</span>, <span style="color:#a6e22e">seq</span>)
		<span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">mutex</span>.<span style="color:#a6e22e">Unlock</span>()

		<span style="color:#66d9ef">switch</span> {
		<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">call</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span>:
			
			<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">client</span>.<span style="color:#a6e22e">codec</span>.<span style="color:#a6e22e">ReadResponseBody</span>(<span style="color:#66d9ef">nil</span>)
			
            <span style="color:#f92672">...</span>.
			
            }
			<span style="color:#a6e22e">call</span>.<span style="color:#a6e22e">done</span>()
		}
	}
	
    <span style="color:#f92672">...</span>
	
	}
}
</code></pre></div><p>主要逻辑是不断循环读取TCP上的流，把Header解析成Response对象，以及将Body解析到call.Reply对象,解析完后触发call中的done函数。这样客户端就可以拿到Reply对象就是服务器返回的结果，可以打印获取其中的值。</p>
<p><strong>总结</strong></p>
<p>client.go分两条线，一条线显示的调用发送请求数据，另外一条线则起协程获取服务器的返回数据。</p>
<h5 id="9抓包分析">9.抓包分析</h5>
<h6 id="1三次握手">1.三次握手</h6>
<p>![](/Users/lx/OneDrive - RLS ,inc/markdown/三次握手.png)</p>
<p>由于使用tcp进行网络传输, 首先需要建立tcp连接, 即三次握手.</p>
<pre><code>第一次握手：客户端发送syn包(syn=j)到服务器，并进入SYN_SEND状态，等待服务器确认；
第二次握手：服务器收到syn包，必须确认客户的SYN（ack=j+1），同时自己也发送一个SYN包（syn=k），即SYN+ACK包，此时服务器进入SYN_RECV状态；
第三次握手：客户端收到服务器的SYN＋ACK包，向服务器发送确认包ACK(ack=k+1)，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。
</code></pre><h6 id="2tcp-windows-update">2.tcp windows update</h6>
<p>![](/Users/lx/OneDrive - RLS ,inc/markdown/windows-update.png)</p>
<p>TCP Window Update 是TCP通信中的一个状态，它可以发生的原因有很多，但最终归结于发送者传输数据的速度比接收者读取的数据还快，这使得接受端的在缓冲区必须释放一部分空间来装发送过来的数据，然后向发送者发送Windows Update(Server 发送给Client)，告诉给发送者应该以多大的速度发送数据，从而使得数据传输与接受恢复正常。</p>
<h6 id="3client发送请求">3.Client发送请求</h6>
<p>![](/Users/lx/OneDrive - RLS ,inc/markdown/query.png)</p>
<p>使用json编码, 没有使用TLS加密, 在wireshark可以直接看出传输的信息</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;method&#34;</span>:<span style="color:#e6db74">&#34;Arith.Multiply&#34;</span>,
  <span style="color:#f92672">&#34;params&#34;</span>:[
    	{
        <span style="color:#f92672">&#34;A&#34;</span>:<span style="color:#ae81ff">17</span>,
        <span style="color:#f92672">&#34;B&#34;</span>:<span style="color:#ae81ff">8</span>
      }
    ],
  <span style="color:#f92672">&#34;id&#34;</span>:<span style="color:#ae81ff">0</span>
}
</code></pre></div><p>server收到请求后发一个ack包.</p>
<h6 id="4server发送回复">4.Server发送回复</h6>
<p>![](/Users/lx/OneDrive - RLS ,inc/markdown/response.png)</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;id&#34;</span>:<span style="color:#ae81ff">0</span>,
  <span style="color:#f92672">&#34;result&#34;</span>:<span style="color:#ae81ff">136</span>,
  <span style="color:#f92672">&#34;error&#34;</span>:<span style="color:#66d9ef">null</span>
}

</code></pre></div><p>client收到回复后发一个ack包.</p>
<h6 id="5四次挥手">5.四次挥手</h6>
<p>![](/Users/lx/OneDrive - RLS ,inc/markdown/四次挥手.png)</p>
<h4 id="rpc-请求与-http">RPC 请求与 HTTP</h4>
<h5 id="1传输协议">1.传输协议</h5>
<pre><code>RPC: 可以基于TCP协议，也可以基于HTTP协议
HTTP: 基于HTTP协议
</code></pre><h5 id="2传输效率">2.传输效率</h5>
<pre><code>RPC: 使用自定义的TCP协议，可以让请求报文体积更小, 提高传输效率
HTTP: 如果是基于HTTP1.1的协议，请求中会包含很多无用的内容，如果是基于HTTP2.0，那么简单的封装以下是可以作为一个RPC来使用的，这时标准RPC框架更多的是服务治理
</code></pre><h5 id="3性能消耗">3.性能消耗</h5>
<pre><code>RPC: 可以基于thrift实现高效的二进制传输
HTTP: 大部分是通过json来实现的，字节大小和序列化耗时都比thrift要更消耗性能
</code></pre><h5 id="4负载均衡">4.负载均衡</h5>
<pre><code>RPC: 基本都自带了负载均衡策略
HTTP: 需要配置Nginx，HAProxy来实现
</code></pre><h5 id="5服务治理">5.服务治理</h5>
<pre><code>RPC: 能做到自动通知，不影响上游
HTTP: 需要事先通知，修改Nginx/HAProxy配置
</code></pre><h5 id="6总结">6.总结</h5>
<pre><code>RPC主要用于公司内部的服务调用，性能消耗低，传输效率高，服务治理方便。
HTTP主要用于对外的异构环境，浏览器接口调用，APP接口调用，第三方接口调用等。
</code></pre><h4 id="iss-rpc">ISS RPC</h4>
<h5 id="1switch与pc交互">1.SWITCH与PC交互</h5>
<p>![](/Users/lx/OneDrive - RLS ,inc/markdown/switch-pc.jpg)</p>
<p>交换机与pc交互有两种方式</p>
<p>​	第一种: 通过Console使用CLI Command, cli只是交换机系统的一个操作页面, 与交换机同属一个系统, 其本质是直接对交换机进行操作, 属于进程间通信, 不涉及	远程调用.</p>
<p>​	![](/Users/lx/OneDrive - RLS ,inc/markdown/cli.png)</p>
<p>​	第二种: 通过网线连接, 比如, 通过pc的浏览器把port2设置为vlan2</p>
<p>​	<!-- raw HTML omitted --></p>
<p>​	PC的浏览器与交换机属于不同系统, 无法使用进程间通信, 这就需要使用远程调用&ndash;&ldquo;RPC&rdquo;.</p>
<h5 id="2与传统rpc区别">2.与传统RPC区别</h5>
<p>ISS的RPC并不是真正意义上的RPC, 只是利用HTTP来模拟RPC. 抓包分析一下:</p>
<p>![](/Users/lx/OneDrive - RLS ,inc/markdown/http-post.png)</p>
<h5 id="3json数据">3.Json数据</h5>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;method&#34;</span>:<span style="color:#e6db74">&#34;BatchPost&#34;</span>,
 	<span style="color:#f92672">&#34;id&#34;</span>:<span style="color:#ae81ff">0</span>,
  <span style="color:#f92672">&#34;params&#34;</span>:[
    {
      <span style="color:#f92672">&#34;dot1qVlanPortIndex&#34;</span>:<span style="color:#e6db74">&#34;2&#34;</span>,
      <span style="color:#f92672">&#34;dot1qVlanPortVlanMode&#34;</span>:<span style="color:#e6db74">&#34;1&#34;</span>,
      <span style="color:#f92672">&#34;VlanList&#34;</span>:<span style="color:#e6db74">&#34;2&#34;</span>,
      <span style="color:#f92672">&#34;FuncName&#34;</span>:<span style="color:#e6db74">&#34;VlanIfCfg&#34;</span>
    }
  ]
}
</code></pre></div><p>由于使用HTTP协议传输数据, 并不需要遵守json-rpc相关规则.</p>
<h5 id="4代码分析">4.代码分析</h5>
<p>交换机收到http包调用ProcessHttpReq (tHttp * pHttp)进行解析</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">INT4
<span style="color:#a6e22e">IssProcessSpecificPage</span> (tHttp <span style="color:#f92672">*</span> pHttp)
{
    UINT4               u4Count;

    <span style="color:#66d9ef">for</span> (u4Count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; asIsspages[u4Count].au1Page[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#39;\0&#39;</span>; u4Count<span style="color:#f92672">++</span>)
    {
        <span style="color:#66d9ef">if</span> (STRCMP (pHttp<span style="color:#f92672">-&gt;</span>ai1HtmlName, asIsspages[u4Count].au1Page) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
        {
            asIsspages[u4Count].pfunctPtr (pHttp);
            <span style="color:#66d9ef">return</span> ISS_SUCCESS;
        }
    }

	<span style="color:#66d9ef">return</span> ISS_FAILURE;
}
</code></pre></div><p>由路由可知web使用rpc.js接口，调用IssProcessSpecificPage对<code>asIsspages</code>进行遍历，找到rpc.js对应的处理函数为CmProcessRpcPage</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">tSpecificPage       asIsspages[] <span style="color:#f92672">=</span> {
	{<span style="color:#e6db74">&#34;bottom.html&#34;</span>, IssProcessBottomPage},
	{<span style="color:#e6db74">&#34;ObjectTreeFrame.htm&#34;</span>, IssProcessObjTreePage},

	......

	{<span style="color:#e6db74">&#34;rpc.js&#34;</span>, CmProcessRpcPage},
	{<span style="color:#e6db74">&#34;const_common.js&#34;</span>, CmProcessConstPage},

}
</code></pre></div><p>CmProcessRpcPage函数有超时处理，然后调用CmAPICallRpc(pchIn,&amp;pchOut, &amp;u4Err, i2RpcId)，pchIn为webpost的json数据，pchOut为交换机底层处理后返回的json数据，</p>
<p>该函数直接调用CmLuaCallService(i2RpcId, pchInJson, ppchOut, pu4Err);</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">INT4 <span style="color:#a6e22e">CmAPICallRpc</span> (CONST CHR1<span style="color:#f92672">*</span> pchInJson, 
					CONST CHR1 <span style="color:#f92672">**</span>ppchOut,UINT4 <span style="color:#f92672">*</span> pu4Err, INT2 i2RpcId)
{
	INT4 i4Ret  <span style="color:#f92672">=</span> CmLuaCallService(i2RpcId, pchInJson, ppchOut, pu4Err);
	<span style="color:#66d9ef">if</span>(i4Ret <span style="color:#f92672">==</span> RPC_SUCCESS)
	{
		<span style="color:#66d9ef">return</span> ISS_SUCCESS;
	}
	<span style="color:#66d9ef">return</span> ISS_FAILURE;
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">INT4 <span style="color:#a6e22e">CmLuaCallService</span> (INT2 i2ConId, CONST CHR1<span style="color:#f92672">*</span> pchInJson, 
		CONST CHR1 <span style="color:#f92672">**</span>ppchOut,UINT4 <span style="color:#f92672">*</span> pu4Err)
{
    lua_State  	<span style="color:#f92672">*</span>L <span style="color:#f92672">=</span> NULL;
    INT4		i4Ret  <span style="color:#f92672">=</span> RPC_FAILURE;
    <span style="color:#75715e">/*CHR1 		*pChrOutTemp = NULL;*/</span>
    <span style="color:#f92672">*</span>pu4Err		<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#66d9ef">if</span> (LUA_INVALID_CHK(i2ConId) <span style="color:#f92672">==</span> RPC_FAILURE)
    {
        <span style="color:#f92672">*</span>pu4Err <span style="color:#f92672">=</span> RPC_LUASTACK_INVALID_CONNID_ERR;
        RPC_ERR(<span style="color:#e6db74">&#34;CmLuaCallService Error, invalid ConnId</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        <span style="color:#66d9ef">return</span> RPC_FAILURE ;
    }
    CMLUA_LOCK();
    <span style="color:#66d9ef">if</span>(LUA_USED(i2ConId) <span style="color:#f92672">==</span> RPC_FALSE)
    {
        <span style="color:#f92672">*</span>pu4Err <span style="color:#f92672">=</span> RPC_LUA_STACK_STATUS_ERR;
        RPC_ERR(<span style="color:#e6db74">&#34;CmLuaCleanService Error, lua stack is invalid</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        CMLUA_UNLOCK();

        <span style="color:#66d9ef">return</span> RPC_FAILURE ;
    }
    CMLUA_UNLOCK();


    L <span style="color:#f92672">=</span> gCmLuaStack[i2ConId].luaStack;
    <span style="color:#66d9ef">do</span>
    {
        <span style="color:#66d9ef">if</span>(L <span style="color:#f92672">==</span> NULL)
        {
            <span style="color:#f92672">*</span>pu4Err <span style="color:#f92672">=</span> RPC_LUA_STATE_NULL;
            RPC_ERR(<span style="color:#e6db74">&#34;RPC_LUA_STATE_NULL</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        }
        <span style="color:#66d9ef">if</span>(pchInJson <span style="color:#f92672">==</span> NULL)
        {
            <span style="color:#f92672">*</span>pu4Err <span style="color:#f92672">=</span> RPC_PARAM_IS_NULL;
            RPC_ERR(<span style="color:#e6db74">&#34;RPC_PARAM_IS_NULL</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        }

        <span style="color:#66d9ef">if</span>(ppchOut <span style="color:#f92672">==</span> NULL)
        {
            <span style="color:#f92672">*</span>pu4Err <span style="color:#f92672">=</span> RPC_PARAM_IS_NULL;
            RPC_ERR(<span style="color:#e6db74">&#34;RPC_PARAM_IS_NULL</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
            <span style="color:#66d9ef">break</span>;
        }
        lua_getglobal(L, <span style="color:#e6db74">&#34;RpcServer&#34;</span>);
        lua_pushstring(L, pchInJson);
        <span style="color:#66d9ef">if</span>(lua_pcall(L,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>)
        {
            <span style="color:#f92672">*</span>pu4Err <span style="color:#f92672">=</span> RPC_LUA_SCRIPT_ERR;
            RPC_ERR1(<span style="color:#e6db74">&#34;lua_pcall failed:%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,lua_tostring(L,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>));
            <span style="color:#f92672">*</span>ppchOut <span style="color:#f92672">=</span> lua_tolstring(L, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL);
            <span style="color:#66d9ef">break</span>;
        }
        <span style="color:#75715e">/*pChrOutTemp = lua_tolstring(L, -1, NULL);*/</span>
        <span style="color:#f92672">*</span>ppchOut <span style="color:#f92672">=</span> lua_tolstring(L, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, NULL);
        <span style="color:#75715e">/* CAMEOTAG: Bob Yu put below in comment 
</span><span style="color:#75715e">        * since lua stack has been separated as newly enhanced, 
</span><span style="color:#75715e">        * output memory could be used and return to caller. 
</span><span style="color:#75715e">        * Thus, memory allocated method is no longer needed.  
</span><span style="color:#75715e">        */</span>
<span style="color:#75715e">#if 0</span><span style="color:#75715e">
</span><span style="color:#75715e">        if (pChrOutTemp != NULL)
</span><span style="color:#75715e">        {
</span><span style="color:#75715e">        *ppchOut = MEM_MALLOC(STRLEN(pChrOutTemp) + 1, CHR1);
</span><span style="color:#75715e">        if (*ppchOut == NULL)
</span><span style="color:#75715e">        {
</span><span style="color:#75715e">        *pu4Err = RPC_MEMORY_ALLOCATE_ERR;
</span><span style="color:#75715e">        RPC_ERR(&#34;CallService:  RPC_MEMORY_ALLOCATE_ERR\n&#34;);
</span><span style="color:#75715e">        break;
</span><span style="color:#75715e">        }
</span><span style="color:#75715e">        MEMCPY(*ppchOut, pChrOutTemp, STRLEN(pChrOutTemp) + 1);
</span><span style="color:#75715e">        }
</span><span style="color:#75715e">        else
</span><span style="color:#75715e">        {
</span><span style="color:#75715e">        *ppchOut = NULL;
</span><span style="color:#75715e">        }
</span><span style="color:#75715e"></span><span style="color:#75715e">#endif
</span><span style="color:#75715e"></span>        lua_pop(L, <span style="color:#ae81ff">1</span>);
        i4Ret  <span style="color:#f92672">=</span> RPC_SUCCESS;
    }<span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">0</span>);


    RPC_CHK_RET(i4Ret);
    <span style="color:#66d9ef">return</span> i4Ret;
}
</code></pre></div><p>rpcserver.lua</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#75715e">-- to parse the request json string.</span>
<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">RpcServer</span>(sJson)
	<span style="color:#75715e">-- support for URL decode.</span>
	<span style="color:#75715e">-- sJson = unescape(sJson); move to CmProcessRpcPage</span>
	<span style="color:#66d9ef">local</span> request <span style="color:#f92672">=</span> json.decode(sJson)
	<span style="color:#75715e">--print(table.tostring(request));</span>
	<span style="color:#66d9ef">if</span>(request[<span style="color:#e6db74">&#39;method&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span>) <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#39;Can not find RPC method&#39;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">local</span> params <span style="color:#f92672">=</span> request[<span style="color:#e6db74">&#39;params&#39;</span>];
	<span style="color:#75715e">-- if only one object.</span>
	<span style="color:#66d9ef">if</span>(request[<span style="color:#e6db74">&#39;params&#39;</span>][<span style="color:#ae81ff">1</span>] <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span>  <span style="color:#f92672">and</span> request[<span style="color:#e6db74">&#39;params&#39;</span>][<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span>) <span style="color:#66d9ef">then</span>
		params <span style="color:#f92672">=</span> request[<span style="color:#e6db74">&#39;params&#39;</span>][<span style="color:#ae81ff">1</span>];
	<span style="color:#66d9ef">end</span>
		
	<span style="color:#66d9ef">local</span> response <span style="color:#f92672">=</span>CallService(request[<span style="color:#e6db74">&#39;method&#39;</span>], params);
	
	<span style="color:#66d9ef">if</span> response <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> <span style="color:#66d9ef">then</span>
		response<span style="color:#f92672">=</span>{};
		response.id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
		response.error<span style="color:#f92672">=</span>{};
		response.error.code <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>; <span style="color:#75715e">-- TODO error.</span>
		response.error.message <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;CallService failed.&#39;</span>;
		response.result <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>;
		<span style="color:#75715e">--dbg_err(&#39;CallService failed.&#39;);</span>
	<span style="color:#66d9ef">end</span>
	
	<span style="color:#66d9ef">local</span> s <span style="color:#f92672">=</span> json.encode(response);
	<span style="color:#66d9ef">return</span> s;
<span style="color:#66d9ef">end</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">CallService</span>(sFun, param)
	<span style="color:#66d9ef">local</span> fun <span style="color:#f92672">=</span> FunList[sFun];
	<span style="color:#66d9ef">local</span> response<span style="color:#f92672">=</span>{};
	

	response.id <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
	<span style="color:#66d9ef">if</span> fun <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		<span style="color:#75715e">-- TODO: send the response.</span>
		dbg_err(<span style="color:#e6db74">&#39;No such function name &#39;</span> <span style="color:#f92672">..</span> sFun);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>
	
	<span style="color:#66d9ef">local</span> ret <span style="color:#f92672">=</span> fun(param);

	<span style="color:#66d9ef">if</span> ret <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#39; Function &#39;</span> <span style="color:#f92672">..</span> sFun<span style="color:#f92672">..</span><span style="color:#e6db74">&#39; pcall error.&#39;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">if</span> ret<span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">or</span> ret.code<span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#39; Function &#39;</span> <span style="color:#f92672">..</span> sFun<span style="color:#f92672">..</span><span style="color:#e6db74">&#39; should return ret table.&#39;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>

	response.error<span style="color:#f92672">=</span>{};
	response.error.code <span style="color:#f92672">=</span> ret.code;

	<span style="color:#66d9ef">if</span> ret.code <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">or</span> ret.result <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		response.result <span style="color:#f92672">=</span> ret.result;
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">if</span> ret.code <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
		response.error.message <span style="color:#f92672">=</span> Mib.error(ret.code);
		<span style="color:#75715e">--dbg_err(&#39;Function &#39; .. sFun..&#39; error, message is &#39;..response.error.message);</span>
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">return</span> response;
<span style="color:#66d9ef">end</span>
</code></pre></div><p>由函数可知是调用fun(param);来处理json，fun是什么呢？</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> fun <span style="color:#f92672">=</span> FunList[sFun];
</code></pre></div><p>FunList是全局变量，在rpcserver.lua声明</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua">FunList	<span style="color:#f92672">=</span> {};
</code></pre></div><p>在写各个模块处理函数时会将函数mapping调用AddFun添加到FunList</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">AddFun</span>(sFun, pfun)
	<span style="color:#66d9ef">if</span> (type(sFun) <span style="color:#f92672">~=</span> <span style="color:#e6db74">&#34;string&#34;</span>) <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#39;The parameter should be string.&#39;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">if</span> (type(pfun) <span style="color:#f92672">~=</span> <span style="color:#e6db74">&#34;function&#34;</span>) <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#39;The parameter should be function. &#39;</span> <span style="color:#f92672">..</span> sFun);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>


	<span style="color:#66d9ef">if</span> FunList[sFun] <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		<span style="color:#75715e">-- TODO: send the response.</span>
		dbg_err(<span style="color:#e6db74">&#39;The Function &#39;</span><span style="color:#f92672">..</span> sFun <span style="color:#f92672">..</span><span style="color:#e6db74">&#39; already exists.&#39;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>

	FunList[sFun] <span style="color:#f92672">=</span> pfun;
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
<span style="color:#66d9ef">end</span>
</code></pre></div><p>vlanif.lua</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#75715e">--Config VLAN interface</span>
<span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">VlanIfCfg</span>(params)
    <span style="color:#75715e">--follow D-Link requirement, set default PortNativeVlanStatus</span>
    <span style="color:#75715e">--value to tag and the trunk port will become tagged port in </span>
    <span style="color:#75715e">--native vlan</span>

    <span style="color:#66d9ef">if</span> tonumber(params[<span style="color:#e6db74">&#39;dot1qVlanPortVlanMode&#39;</span>]) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span>
        <span style="color:#75715e">--when set vlan mode as access and the specified vlan does not exist, should create first</span>
        <span style="color:#66d9ef">local</span> oSeq1 <span style="color:#f92672">=</span> {
            {dot1qVlanId <span style="color:#f92672">=</span> tonumber(params[<span style="color:#e6db74">&#39;VlanList&#39;</span>])},
        };
        <span style="color:#66d9ef">local</span> dot1qVlanTable <span style="color:#f92672">=</span> GetEntry(<span style="color:#e6db74">&#39;dot1qVlanEntry&#39;</span>,oSeq1);

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">#</span>dot1qVlanTable <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
            <span style="color:#66d9ef">local</span> oSeq <span style="color:#f92672">=</span> {
            {dot1qVlanId <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;VlanList&#39;</span>]},
                {dot1qVlanRowStatus <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;4&#39;</span>}
            };
            ret <span style="color:#f92672">=</span> Post(<span style="color:#e6db74">&#39;dot1qVlanEntry&#39;</span>, oSeq);
            <span style="color:#66d9ef">if</span> ret.code <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
                <span style="color:#66d9ef">return</span> ret;
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">local</span> oSeq <span style="color:#f92672">=</span> {
        {dot1qVlanPortIndex <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortIndex&#39;</span>]},
        {dot1qVlanPortVlanMode <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortVlanMode&#39;</span>]},
        {dot1qVlanPortAcceptableFrameType <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortAcceptableFrameType&#39;</span>]},
        {dot1qVlanPortIngressChecking <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortIngressChecking&#39;</span>]},
        {dot1qVlanPortNativeVlanId <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortNativeVlanId&#39;</span>]},
    };
    <span style="color:#75715e">--Debug(&#39;dot1qVlanPortEntry&#39;, oSeq);</span>
    <span style="color:#66d9ef">local</span> ret<span style="color:#f92672">=</span>Post(<span style="color:#e6db74">&#39;dot1qVlanPortEntry&#39;</span>, oSeq);
    <span style="color:#66d9ef">if</span> ret.code <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">return</span> ret;
    <span style="color:#66d9ef">end</span>

    <span style="color:#75715e">--Get current port&#39;s vlan configuration</span>
    <span style="color:#66d9ef">local</span> oSeq1 <span style="color:#f92672">=</span> {
        {dot1qVlanPortIndex <span style="color:#f92672">=</span> tonumber(params[<span style="color:#e6db74">&#39;dot1qVlanPortIndex&#39;</span>])},
    };
    <span style="color:#66d9ef">local</span> dot1qVlanPortTable <span style="color:#f92672">=</span> GetEntry(<span style="color:#e6db74">&#39;dot1qVlanPortEntry&#39;</span>,oSeq1);

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">#</span>dot1qVlanPortTable <span style="color:#f92672">~=</span> <span style="color:#ae81ff">1</span>  <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">return</span> {} ;
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">local</span> dot1qVlanPortEntry <span style="color:#f92672">=</span> dot1qVlanPortTable[<span style="color:#ae81ff">1</span>];

    <span style="color:#75715e">--integrate setting allowed vlan list with current allowed vlan list</span>
    <span style="color:#66d9ef">local</span> TagVlanListHexStr,UntagVlanListHexStr <span style="color:#f92672">=</span> VlanListIntegrate(
                                                    params[<span style="color:#e6db74">&#34;dot1qVlanPortIndex&#34;</span>],
                                                    params[<span style="color:#e6db74">&#34;dot1qVlanPortVlanMode&#34;</span>],
                                                    params[<span style="color:#e6db74">&#34;VlanList&#34;</span>],
                                                    params[<span style="color:#e6db74">&#34;VlanListAction&#34;</span>],
                                                    params[<span style="color:#e6db74">&#34;VlanListTag&#34;</span>],
                                                    dot1qVlanPortEntry
                                                );

    oSeq <span style="color:#f92672">=</span> {
        {dot1qVlanPortIndex <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortIndex&#39;</span>]},
        {dot1qVlanPortTagVlanList <span style="color:#f92672">=</span> TagVlanListHexStr},
        {dot1qVlanPortUntagVlanList <span style="color:#f92672">=</span> UntagVlanListHexStr}
    }
	ret <span style="color:#f92672">=</span> Post(<span style="color:#e6db74">&#39;dot1qVlanPortEntry&#39;</span>, oSeq);
    <span style="color:#75715e">--[[CAMEOTAG:Add by toney 2019/09/28
</span><span style="color:#75715e">	ignore VLAN_SET_DOT1Q_VLAN_PORTS_IN_USE err code
</span><span style="color:#75715e">	because cloud always push same dot1qVlanPortUntagVlanList config data.
</span><span style="color:#75715e">	
</span><span style="color:#75715e">	Test setp:
</span><span style="color:#75715e">	1.enable voice vlan
</span><span style="color:#75715e">	2.add mac to mac whitelist which be matched existed voice OUI (this port will add voice VLAN)
</span><span style="color:#75715e">	
</span><span style="color:#75715e">	but dot1qVlanPortUntagVlanList not include voice vlan,so will do delete voice vlan from  this port&#39;s vlan list
</span><span style="color:#75715e">	and return VLAN_SET_DOT1Q_VLAN_PORTS_IN_USE error.
</span><span style="color:#75715e">	
</span><span style="color:#75715e">	I have already made a suggestion to portal RD,dont push same config data.
</span><span style="color:#75715e">	]]</span>
	
	<span style="color:#66d9ef">if</span>  ret.code <span style="color:#f92672">==</span> cmacro.VLAN_SET_DOT1Q_VLAN_PORTS_IN_USE <span style="color:#66d9ef">then</span>
		ret.code <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
	<span style="color:#66d9ef">end</span>
	
    <span style="color:#66d9ef">if</span> ret.code <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">return</span> ret;
    <span style="color:#66d9ef">end</span>
	
    <span style="color:#66d9ef">if</span> params[<span style="color:#e6db74">&#39;Cloneportlist&#39;</span>] <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
        <span style="color:#66d9ef">local</span> ClonePortList <span style="color:#f92672">=</span> util.ListStrToListArry(params[<span style="color:#e6db74">&#39;Cloneportlist&#39;</span>]);
        <span style="color:#66d9ef">local</span> ClonePortNum <span style="color:#f92672">=</span> <span style="color:#f92672">#</span>ClonePortList;

        <span style="color:#66d9ef">for</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, ClonePortNum <span style="color:#66d9ef">do</span>
            <span style="color:#75715e">--the being cloned port no need set again		</span>
            <span style="color:#66d9ef">if</span> ClonePortList[i] <span style="color:#f92672">~=</span> tonumber(params[<span style="color:#e6db74">&#39;dot1qVlanPortIndex&#39;</span>]) <span style="color:#66d9ef">then</span>			
                <span style="color:#66d9ef">local</span> oSeq1 <span style="color:#f92672">=</span> {
                    {dot1qVlanPortIndex <span style="color:#f92672">=</span> ClonePortList[i]},
                    {dot1qVlanPortVlanMode <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortVlanMode&#39;</span>]},
                    {dot1qVlanPortAcceptableFrameType <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortAcceptableFrameType&#39;</span>]},
                    {dot1qVlanPortIngressChecking <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortIngressChecking&#39;</span>]},
                    {dot1qVlanPortNativeVlanStatus <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortNativeVlanStatus&#39;</span>]},
                    {dot1qVlanPortNativeVlanId <span style="color:#f92672">=</span> params[<span style="color:#e6db74">&#39;dot1qVlanPortNativeVlanId&#39;</span>]}
                };
				
                ret<span style="color:#f92672">=</span>Post(<span style="color:#e6db74">&#39;dot1qVlanPortEntry&#39;</span>, oSeq1);
                <span style="color:#66d9ef">if</span> ret.code <span style="color:#f92672">~=</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
                    <span style="color:#66d9ef">break</span>;
                <span style="color:#66d9ef">end</span>

                dot1qVlanPortEntry <span style="color:#f92672">=</span> GetEntry(<span style="color:#e6db74">&#39;dot1qVlanPortEntry&#39;</span>);
                <span style="color:#66d9ef">local</span> TagVlanListHexStr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
                <span style="color:#66d9ef">local</span> UntagVlanListHexStr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
                TagVlanListHexStr,UntagVlanListHexStr <span style="color:#f92672">=</span> VlanListIntegrate(
                                                            ClonePortList[i],
                                                            params[<span style="color:#e6db74">&#34;dot1qVlanPortVlanMode&#34;</span>],
                                                            params[<span style="color:#e6db74">&#34;VlanList&#34;</span>],
                                                            params[<span style="color:#e6db74">&#34;VlanListAction&#34;</span>],
                                                            params[<span style="color:#e6db74">&#34;VlanListTag&#34;</span>],
                                                            GetDot1qVlanPortInfo(dot1qVlanPortEntry, ClonePortList[i])
                                                        );

                oSeq1 <span style="color:#f92672">=</span> {
                    {dot1qVlanPortIndex <span style="color:#f92672">=</span> ClonePortList[i]},
                    {dot1qVlanPortTagVlanList <span style="color:#f92672">=</span> TagVlanListHexStr},
                    {dot1qVlanPortUntagVlanList <span style="color:#f92672">=</span> UntagVlanListHexStr}
                };

                ret<span style="color:#f92672">=</span>Post(<span style="color:#e6db74">&#39;dot1qVlanPortEntry&#39;</span>, oSeq1);
			
				<span style="color:#66d9ef">if</span>  ret.code <span style="color:#f92672">==</span> cmacro.VLAN_SET_DOT1Q_VLAN_PORTS_IN_USE <span style="color:#66d9ef">then</span>
					ret.code <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
				<span style="color:#66d9ef">end</span>
				
            <span style="color:#66d9ef">end</span>
        <span style="color:#66d9ef">end</span>
    <span style="color:#66d9ef">end</span>

    <span style="color:#66d9ef">return</span> ret;
<span style="color:#66d9ef">end</span>

Fun.Add(<span style="color:#e6db74">&#39;VlanIfCfg&#39;</span>, VlanIfCfg);
</code></pre></div><p>post方法调用</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">function</span>  <span style="color:#a6e22e">Post</span>(sTmp, oSeq)
	<span style="color:#66d9ef">return</span> SeqCommit(sTmp, <span style="color:#ae81ff">2</span>, oSeq);
<span style="color:#66d9ef">end</span>
</code></pre></div><h6 id="interfacelua">interface.lua</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#75715e">-- nAction 1:get; 2:post; 3:debug</span>
<span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">SeqCommit</span>(sTmp, nAction, oSeq)
    
tab:Init(sTmp);
    
<span style="color:#66d9ef">if</span> nAction <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">then</span>
	ret.code <span style="color:#f92672">=</span> tab:Post();
<span style="color:#66d9ef">end</span>
</code></pre></div><h6 id="tablelua">table.lua</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Table</span>:<span style="color:#a6e22e">Init</span>(sName)
	<span style="color:#66d9ef">if</span> sName <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#39;Table:Init error, Name is nil.&#39;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>;
	<span style="color:#66d9ef">end</span>
	self._Name  	<span style="color:#f92672">=</span> sName;
	self._Template 	<span style="color:#f92672">=</span> Template;
	self._Pairs <span style="color:#f92672">=</span> {};
	<span style="color:#66d9ef">if</span> self._Template:Init(self._Name) <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> <span style="color:#66d9ef">then</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
<span style="color:#66d9ef">end</span>
</code></pre></div><h6 id="templatelua">template.lua</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Template</span>:<span style="color:#a6e22e">Init</span>(sName)
	self._Data <span style="color:#f92672">=</span> Load(sName);

	<span style="color:#66d9ef">if</span> self._Data <span style="color:#f92672">==</span><span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	<span style="color:#66d9ef">end</span>;
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
<span style="color:#66d9ef">end</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Load</span>(sName)
	<span style="color:#75715e">--[[if CheckFile(sName) == false then
</span><span style="color:#75715e">		dbg_err(&#34;Template &#34;..sName.. &#34; may be not exist.&#34;);
</span><span style="color:#75715e">		return nil;
</span><span style="color:#75715e">	end]]</span>
	<span style="color:#66d9ef">local</span> res, baseoid <span style="color:#f92672">=</span> CheckFile(sName);
	<span style="color:#66d9ef">if</span> res <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#34;Template &#34;</span><span style="color:#f92672">..</span>sName<span style="color:#f92672">..</span><span style="color:#e6db74">&#34; may be not exist.&#34;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>;
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">local</span> _oData  <span style="color:#f92672">=</span> dofile(<span style="color:#e6db74">&#39;./cmscript/cust_ln/template/&#39;</span><span style="color:#f92672">..</span>sName <span style="color:#f92672">..</span><span style="color:#e6db74">&#39;.tmp.lua&#39;</span>)
	<span style="color:#66d9ef">if</span> _oData <span style="color:#f92672">==</span><span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#34;Template load &#34;</span><span style="color:#f92672">..</span>sName<span style="color:#f92672">..</span> <span style="color:#e6db74">&#34; Failed.&#34;</span>)
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>;
	<span style="color:#66d9ef">end</span>;
	
	<span style="color:#66d9ef">if</span> baseoid <span style="color:#f92672">~=</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		_oData.Base[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> baseoid;
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">if</span> CheckTmp(_oData) <span style="color:#f92672">==</span> <span style="color:#66d9ef">false</span> <span style="color:#66d9ef">then</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>;
	<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">return</span> _oData;
<span style="color:#66d9ef">end</span>
</code></pre></div><h6 id="dot1qvlanentrytmplua">dot1qVlanEntry.tmp.lua</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">return</span> {
	<span style="color:#75715e">-- {Name, OID}</span>
	Base<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;dot1qVlanEntry&#34;</span>,RootOffset(<span style="color:#e6db74">&#34;4.2.2.1&#34;</span>)},
	<span style="color:#75715e">--Base={&#34;dot1qVlanEntry&#34;,&#34;1.3.6.1.4.1.171.11.163.1000.4.2.2.1&#34;},</span>
	<span style="color:#75715e">--{Name, Offset, Type, Access}</span>
		<span style="color:#75715e">-- Access:0-ReadOnly; 1,2-R&amp;W; 3-NotAccess</span>
	Index <span style="color:#f92672">=</span> 
	{
		{<span style="color:#e6db74">&#34;dot1qVlanId&#34;</span>,	<span style="color:#ae81ff">1</span>,	<span style="color:#ae81ff">2</span>,	<span style="color:#ae81ff">0</span>},
		
	},
	Field <span style="color:#f92672">=</span> 
	{
		{<span style="color:#e6db74">&#34;dot1qVlanName&#34;</span>,	<span style="color:#ae81ff">2</span>,	<span style="color:#ae81ff">11</span>,	<span style="color:#ae81ff">1</span>},
		{<span style="color:#e6db74">&#34;dot1qVlanEgressPorts&#34;</span>,	<span style="color:#ae81ff">3</span>,	<span style="color:#ae81ff">3</span>,	<span style="color:#ae81ff">0</span>},
		{<span style="color:#e6db74">&#34;dot1qVlanUntaggedPorts&#34;</span>,	<span style="color:#ae81ff">4</span>,	<span style="color:#ae81ff">3</span>,	<span style="color:#ae81ff">0</span>},
	},
	Status<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;dot1qVlanRowStatus&#34;</span>,	<span style="color:#ae81ff">99</span>,	<span style="color:#ae81ff">2</span>,	<span style="color:#ae81ff">1</span>},
		
};
</code></pre></div><h6 id="interfacelua-1">interface.lua</h6>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">Table</span>:<span style="color:#a6e22e">Post</span>()
	<span style="color:#66d9ef">return</span> TableSet(self._Template, self._Pairs, <span style="color:#ae81ff">1</span>);
<span style="color:#66d9ef">end</span>
</code></pre></div><p>tableset.lua</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">TableSet</span>(oTmp, oPairs, isDebug)
	<span style="color:#66d9ef">local</span> ins<span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>;
	<span style="color:#66d9ef">if</span> ins <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		ins <span style="color:#f92672">=</span> TableInstanse(oTmp, oPairs);
	<span style="color:#66d9ef">end</span>
	<span style="color:#75715e">--isDebug=2 means that multi-entry post, allowing post data does not include index </span>
	<span style="color:#66d9ef">if</span> ins <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#f92672">and</span> isDebug <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">then</span>
		dbg_err(<span style="color:#e6db74">&#39;Data2Instanse return nil.&#39;</span>);
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
	<span style="color:#66d9ef">end</span>

	<span style="color:#66d9ef">local</span> queue <span style="color:#f92672">=</span> Update2Queue(oTmp, ins, oPairs,isDebug);
	<span style="color:#66d9ef">if</span> queue <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">if</span> isDebug <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
		<span style="color:#66d9ef">return</span> QueueDump(queue);
	<span style="color:#66d9ef">else</span>
		<span style="color:#66d9ef">return</span> QueueSet(queue);
	<span style="color:#66d9ef">end</span>
<span style="color:#66d9ef">end</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">QueueSet</span>(queue)
	<span style="color:#66d9ef">local</span> i, item;
	<span style="color:#66d9ef">local</span> ret;
	
	<span style="color:#66d9ef">local</span> len <span style="color:#f92672">=</span> table.getn(queue)
	<span style="color:#66d9ef">for</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, len <span style="color:#66d9ef">do</span>
		item <span style="color:#f92672">=</span> queue[i];
		<span style="color:#66d9ef">if</span> item[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
			ret <span style="color:#f92672">=</span>SessionCheck(item[<span style="color:#ae81ff">1</span>], item[<span style="color:#ae81ff">3</span>], item[<span style="color:#ae81ff">4</span>])
		<span style="color:#66d9ef">else</span>
			ret <span style="color:#f92672">=</span>NodeSet(item[<span style="color:#ae81ff">1</span>], item[<span style="color:#ae81ff">2</span>], item[<span style="color:#ae81ff">3</span>], item[<span style="color:#ae81ff">4</span>]);
		<span style="color:#66d9ef">end</span>
		<span style="color:#66d9ef">if</span> ret <span style="color:#f92672">~=</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">then</span>
			<span style="color:#75715e">--dbg_err(&#39;NodeSet error, name=&#39;..node.Name..&#39; err= &#39;..Mib.error(ret));</span>
			<span style="color:#66d9ef">return</span> ret;
		<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
<span style="color:#66d9ef">end</span>
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">NodeSet</span>(node, sInstanse, sVal, multiEntryFlag)
	<span style="color:#66d9ef">local</span> oid <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>
	
	<span style="color:#66d9ef">if</span> multiEntryFlag <span style="color:#f92672">~=</span> <span style="color:#ae81ff">2</span> <span style="color:#66d9ef">then</span>
		oid <span style="color:#f92672">=</span> node.Base<span style="color:#f92672">..</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">..</span>node.Offset;
		oid <span style="color:#f92672">=</span> oid <span style="color:#f92672">..</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">..</span>sInstanse;
	<span style="color:#66d9ef">elseif</span> node <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> <span style="color:#66d9ef">then</span>
		oid <span style="color:#f92672">=</span> RootOffset(<span style="color:#e6db74">&#34;65535&#34;</span>)
		node <span style="color:#f92672">=</span> {}
		node.Type <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#75715e">--Object Identifier</span>
		node.Access <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#75715e">--R&amp;W</span>
		sVal <span style="color:#f92672">=</span> sInstanse
	<span style="color:#66d9ef">else</span>
		oid <span style="color:#f92672">=</span> node.Base<span style="color:#f92672">..</span><span style="color:#e6db74">&#39;.&#39;</span><span style="color:#f92672">..</span>node.Offset;
		<span style="color:#75715e">--oid = oid ..&#39;.&#39;..sInstanse;</span>
	<span style="color:#66d9ef">end</span>
	
	<span style="color:#66d9ef">local</span> ret <span style="color:#f92672">=</span> Mib.set(oid, node.Type, node.Access, sVal)
	<span style="color:#66d9ef">if</span> ret <span style="color:#f92672">~=</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">then</span>
		<span style="color:#75715e">--dbg_err(&#39;Mib.set error, name=&#39;..node.Name..&#39; err= &#39;..Mib.error(ret));</span>
		<span style="color:#66d9ef">return</span> ret;
	<span style="color:#66d9ef">end</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
<span style="color:#66d9ef">end</span>
</code></pre></div><p>最后调用Mib.set</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua">Mib<span style="color:#f92672">=</span> {
	[<span style="color:#e6db74">&#39;get&#39;</span>]			<span style="color:#f92672">=</span>	_MibGet,
	[<span style="color:#e6db74">&#39;set&#39;</span>]			<span style="color:#f92672">=</span>	_MibSet,
	[<span style="color:#e6db74">&#39;next&#39;</span>] 		<span style="color:#f92672">=</span>	_MibNext,
	[<span style="color:#e6db74">&#39;index&#39;</span>] 		<span style="color:#f92672">=</span>	_Index2Str,
	[<span style="color:#e6db74">&#39;instance&#39;</span>]	<span style="color:#f92672">=</span>	_Str2Index,
	[<span style="color:#e6db74">&#39;error&#39;</span>]		<span style="color:#f92672">=</span>	_Err2Str,
	[<span style="color:#e6db74">&#39;check&#39;</span>]		<span style="color:#f92672">=</span>	_SessionCheck, <span style="color:#75715e">--CSMME check</span>
};
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">_MibSet</span>(_sOid, _nType, _nAccess, _sVal)
	<span style="color:#66d9ef">local</span> nErr <span style="color:#f92672">=</span> MibSet(_sOid, _nType, _nAccess, _sVal);
	<span style="color:#66d9ef">if</span> nErr <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">then</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>;
	<span style="color:#66d9ef">end</span>
	<span style="color:#75715e">--dbg_err(&#39;Set =&#39; .._sVal .. &#39; Eorrr(&#39; ..nErr .. &#39;):&#39; ..sErr);</span>
	<span style="color:#66d9ef">return</span> nErr;
<span style="color:#66d9ef">end</span>
</code></pre></div><p>scripts.c</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">PRIVATE INT4 <span style="color:#a6e22e">l_MibSet</span>(lua_State <span style="color:#f92672">*</span>L)
{

	INT4 i4Len <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
	UINT4 u4Err <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

	CHR1 achOid[RPC_STR_LEN]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>};
	CHR1 achVal[RPC_VALUE_LEN]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>};
	
	<span style="color:#66d9ef">const</span> CHR1 <span style="color:#f92672">*</span>sKey 	<span style="color:#f92672">=</span> luaL_checkstring(L, <span style="color:#ae81ff">1</span>);
	INT4 i4Type		<span style="color:#f92672">=</span> luaL_checkint(L, <span style="color:#ae81ff">2</span>);
	INT4 i4Access		<span style="color:#f92672">=</span> luaL_checkint(L, <span style="color:#ae81ff">3</span>);
	<span style="color:#66d9ef">const</span> CHR1 <span style="color:#f92672">*</span>sVal 	<span style="color:#f92672">=</span> luaL_checkstring(L, <span style="color:#ae81ff">4</span>);

	<span style="color:#66d9ef">do</span>{
		<span style="color:#66d9ef">if</span>(sKey <span style="color:#f92672">==</span> NULL)
		{
			RPC_ERR(<span style="color:#e6db74">&#34;l_MibSet key is NULL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
			u4Err <span style="color:#f92672">=</span> RPC_PARAM_IS_NULL;
			<span style="color:#66d9ef">break</span>;
		}
		<span style="color:#66d9ef">if</span>(sVal <span style="color:#f92672">==</span> NULL)
		{
			RPC_ERR(<span style="color:#e6db74">&#34;l_MibSet value is NULL.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
			u4Err <span style="color:#f92672">=</span> RPC_PARAM_IS_NULL;
			<span style="color:#66d9ef">break</span>;
		}
		i4Len <span style="color:#f92672">=</span> STRLEN(sKey);
		<span style="color:#66d9ef">if</span>(i4Len<span style="color:#f92672">&gt;</span>RPC_STR_LEN)
		{
			RPC_ERR(<span style="color:#e6db74">&#34;l_MibSet key string len will be overflow.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
			u4Err <span style="color:#f92672">=</span> RPC_STR_LEN_OVERFLOW;
			<span style="color:#66d9ef">break</span>;
		}		
		STRNCPY(achOid, sKey, i4Len);

		i4Len <span style="color:#f92672">=</span> STRLEN(sVal);
		<span style="color:#66d9ef">if</span>(i4Len<span style="color:#f92672">&gt;</span>RPC_STR_LEN)
		{
			RPC_ERR(<span style="color:#e6db74">&#34;l_MibSet value string len will be overflow.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
			u4Err <span style="color:#f92672">=</span> RPC_STR_LEN_OVERFLOW;
			<span style="color:#66d9ef">break</span>;
		}		
		STRNCPY(achVal, sVal, i4Len);

		<span style="color:#66d9ef">if</span>(MibSet(achOid, i4Type, i4Access, achVal,<span style="color:#f92672">&amp;</span>u4Err)<span style="color:#f92672">==</span>RPC_FAILURE)
		{
			RPC_ERR3(<span style="color:#e6db74">&#34;l_MibSet key=%s u4Err=%u, Msg=%s.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, 
				sKey,u4Err, CmErr2Str((INT4)u4Err));
			<span style="color:#66d9ef">break</span>;
		}
		u4Err <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
	}<span style="color:#66d9ef">while</span>(<span style="color:#ae81ff">0</span>);
	
	lua_pushinteger (L, u4Err);
	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>最后调用SNMP模块的MibSet设置mib.</p>
<h5 id="5总结">5.总结</h5>
<p>ISS借助了RPC的思想, 通过http将json送到交换机, 交换机解析json找到method, 调用对应的lua函数处理, lua函数解析oid, 参数, 最终调SNMP模块设置mib.</p>
</article>
    <footer class="post-footer">
      
      <p class="post-copyright">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License，please give source if you wish to quote or reproduce.This post was published <strong>316</strong> days ago, content in the post may be inaccurate, even wrong now, please take risk yourself.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "disqus_shortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  
<footer class="site-footer">
  <p>© 2017-2021 Hugo Blog</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank" rel="noopener">Nuo</a>.</p>
  
</footer>


<script src="https://cdn.jsdelivr.net/npm/smooth-scroll@15.0.0/dist/smooth-scroll.min.js"></script>



<script async src="https://cdn.jsdelivr.net/npm/video.js@7.3.0/dist/video.min.js"></script>




<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\\[','\\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    },
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>



<script src="/scripts/index.min.js"></script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('\/service-worker.js').then(function() {
      console.log('[ServiceWorker] Registered');
    });
  }
</script>




<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







  </body>
</html>
